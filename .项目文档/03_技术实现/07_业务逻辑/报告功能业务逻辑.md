# 报告功能业务逻辑文档

## 概述

本文档详细描述报告功能的核心业务逻辑，包括笔记数量计算、增量笔记计算、批量操作、筛选和搜索等。

---

## 1. 笔记数量计算逻辑（创建报告时）

### 1.1 功能描述

计算符合筛选条件（品牌、时间范围）的笔记总数，用于创建报告对话框的动态显示。

### 1.2 计算规则

**筛选条件**:
- 品牌筛选：`BrandId IN (brandIds)`
- 时间范围筛选：`PubDate >= startDate AND PubDate <= endDate`

**SQL查询**:

```sql
SELECT COUNT(*) as total_count
FROM qiangua_note_info
WHERE 
    -- 品牌筛选（多选）
    ($1::VARCHAR[] IS NULL OR "BrandId" = ANY($1::VARCHAR[]))
    -- 时间范围筛选
    AND ($2::DATE IS NULL OR "PubDate" >= $2)
    AND ($3::DATE IS NULL OR "PubDate" <= $3);
```

### 1.3 业务规则

1. **品牌筛选**:
   - 至少选择1个品牌
   - 支持多选品牌（OR关系）
   - 如果未选择品牌，返回0

2. **时间范围筛选**:
   - 可选，不选择时不过滤时间
   - 开始日期和结束日期可以单独设置
   - 如果设置了时间范围，必须满足 `startDate <= endDate`

3. **计算时机**:
   - 品牌选择变化时自动触发
   - 时间范围变化时自动触发
   - 计算过程中禁用提交按钮

### 1.4 错误处理

- 品牌ID数组为空：返回0
- 时间范围无效：返回错误提示
- 数据库查询失败：返回错误提示

---

## 2. 增量笔记计算逻辑（追加笔记时）

### 2.1 功能描述

计算符合筛选条件且不在当前报告中的笔记数量（增量），用于追加笔记对话框的动态显示。

### 2.2 计算规则

**筛选条件**:
- 品牌筛选：`BrandId IN (brandIds)`
- 时间范围筛选：`PubDate >= startDate AND PubDate <= endDate`
- 排除条件：笔记ID不在当前报告的 `report_notes` 表中（无论状态如何）

**SQL查询**:

```sql
SELECT COUNT(*) as new_count
FROM qiangua_note_info n
WHERE 
    -- 品牌筛选（多选）
    ($1::VARCHAR[] IS NULL OR n."BrandId" = ANY($1::VARCHAR[]))
    -- 时间范围筛选
    AND ($2::DATE IS NULL OR n."PubDate" >= $2)
    AND ($3::DATE IS NULL OR n."PubDate" <= $3)
    -- 排除已在报告中的笔记（无论状态如何）
    AND NOT EXISTS (
        SELECT 1 FROM report_notes rn
        WHERE rn."ReportId" = $4
        AND rn."NoteId" = n."NoteId"
    );
```

### 2.3 业务规则

1. **去重逻辑**:
   - 笔记ID已在报告中（无论 `active` 或 `ignored` 状态），都视为已存在
   - 使用 `NOT EXISTS` 子查询排除已存在的笔记
   - 基于 `(ReportId, NoteId)` 唯一约束确保不重复

2. **计算时机**:
   - 品牌选择变化时自动触发
   - 时间范围变化时自动触发
   - 计算过程中禁用提交按钮

3. **默认值处理**:
   - 品牌选择：默认选中报告内所有笔记涉及的品牌集合
   - 时间范围：默认留空（不过滤时间）

### 2.4 错误处理

- 报告不存在：返回错误提示
- 品牌ID数组为空：返回0
- 数据库查询失败：返回错误提示

---

## 3. 批量操作逻辑

### 3.1 忽略笔记

**功能描述**: 将笔记标记为忽略状态，不参与分析。

**操作步骤**:

1. 验证报告存在且用户有权限
2. 验证笔记ID数组不为空
3. 批量更新 `report_notes` 表的 `Status` 字段为 `'ignored'`
4. 使用事务确保一致性

**SQL更新**:

```sql
UPDATE report_notes
SET "Status" = 'ignored', "UpdatedAt" = NOW()
WHERE "ReportId" = $1
    AND "NoteId" = ANY($2::VARCHAR[])
    AND "Status" = 'active';
```

**业务规则**:
- 只能忽略状态为 `active` 的笔记
- 忽略后笔记仍然保留在报告中，但不参与分析
- 可以在"已忽略"tab中查看和恢复

### 3.2 删除笔记

**功能描述**: 从报告中物理删除笔记（移除关联记录）。

**操作步骤**:

1. 验证报告存在且用户有权限
2. 验证笔记ID数组不为空
3. 弹出确认对话框（前端处理）
4. 用户确认后，批量删除 `report_notes` 记录
5. 使用事务确保一致性

**SQL删除**:

```sql
DELETE FROM report_notes
WHERE "ReportId" = $1
    AND "NoteId" = ANY($2::VARCHAR[]);
```

**业务规则**:
- 删除操作不可恢复（物理删除）
- 删除笔记后，笔记从报告中完全移除
- 如果报告中的所有笔记都被删除，报告仍然保留（但不会显示在列表中，或显示为空报告）

### 3.3 恢复笔记

**功能描述**: 将已忽略的笔记恢复到有效状态。

**操作步骤**:

1. 验证报告存在且用户有权限
2. 验证笔记ID数组不为空
3. 批量更新 `report_notes` 表的 `Status` 字段为 `'active'`
4. 使用事务确保一致性

**SQL更新**:

```sql
UPDATE report_notes
SET "Status" = 'active', "UpdatedAt" = NOW()
WHERE "ReportId" = $1
    AND "NoteId" = ANY($2::VARCHAR[])
    AND "Status" = 'ignored';
```

**业务规则**:
- 只能恢复状态为 `ignored` 的笔记
- 恢复后笔记重新参与分析
- 恢复后笔记出现在"有效笔记"tab中

---

## 4. 筛选和搜索逻辑

### 4.1 筛选条件

**支持的筛选字段**:

1. **品牌筛选** (`brandId`):
   - 单品牌筛选
   - 从报告内所有笔记涉及的品牌列表中选择

2. **博主筛选** (`bloggerId`):
   - 单博主筛选
   - 从报告内所有笔记涉及的博主列表中选择

3. **日期范围筛选** (`startDate`, `endDate`):
   - 选择开始日期和结束日期
   - 基于笔记的 `PubDate` 字段筛选

**SQL查询**:

```sql
SELECT 
    n.*,
    rn."Status",
    rn."CreatedAt" as added_at
FROM report_notes rn
INNER JOIN qiangua_note_info n ON rn."NoteId" = n."NoteId"
WHERE rn."ReportId" = $1
    AND rn."Status" = $2  -- 'active' 或 'ignored'
    -- 品牌筛选
    AND ($3::VARCHAR IS NULL OR n."BrandId" = $3)
    -- 博主筛选
    AND ($4::VARCHAR IS NULL OR n."BloggerId" = $4)
    -- 日期范围筛选
    AND ($5::DATE IS NULL OR n."PubDate" >= $5)
    AND ($6::DATE IS NULL OR n."PubDate" <= $6)
    -- 搜索关键词（标题、品牌名称）
    AND ($7::VARCHAR IS NULL OR 
         n."Title" ILIKE '%' || $7 || '%' OR 
         n."BrandName" ILIKE '%' || $7 || '%')
ORDER BY n."PublishTime" DESC
LIMIT $8 OFFSET $9;
```

### 4.2 搜索逻辑

**搜索字段**:
- 笔记标题 (`Title`)
- 品牌名称 (`BrandName`)

**搜索方式**:
- 使用 `ILIKE` 进行不区分大小写的模糊匹配
- 支持部分匹配（`%keyword%`）

**搜索时机**:
- 实时搜索（输入后300ms防抖）
- 搜索关键词为空时不过滤

### 4.3 排序逻辑

**支持的排序字段**:
- `PublishTime`（发布时间，默认）
- `LikedCount`（点赞数）
- `ViewCount`（浏览数）
- `CommentsCount`（评论数）
- `ShareCount`（分享数）

**排序方向**:
- `asc`（升序）
- `desc`（降序，默认）

**默认排序**:
- 按发布时间降序（最新在前）

---

## 5. 报告统计信息计算逻辑

### 5.1 有效笔记数

**计算方式**:

```sql
SELECT COUNT(*) as active_notes_count
FROM report_notes
WHERE "ReportId" = $1
    AND "Status" = 'active';
```

### 5.2 已忽略笔记数

**计算方式**:

```sql
SELECT COUNT(*) as ignored_notes_count
FROM report_notes
WHERE "ReportId" = $1
    AND "Status" = 'ignored';
```

### 5.3 统计时间范围

**计算方式**:

```sql
SELECT 
    MIN(n."PublishTime") as earliest_note_time,
    MAX(n."PublishTime") as latest_note_time
FROM report_notes rn
INNER JOIN qiangua_note_info n ON rn."NoteId" = n."NoteId"
WHERE rn."ReportId" = $1;
```

**说明**:
- 包含所有状态的笔记（`active` 和 `ignored`）
- 显示报告内最早和最晚笔记的发布时间

### 5.4 报告内品牌列表

**计算方式**:

```sql
SELECT DISTINCT n."BrandId", n."BrandName"
FROM report_notes rn
INNER JOIN qiangua_note_info n ON rn."NoteId" = n."NoteId"
WHERE rn."ReportId" = $1
    AND n."BrandId" IS NOT NULL
ORDER BY n."BrandName";
```

**用途**:
- 用于追加笔记对话框的默认品牌选择

---

## 6. 创建报告逻辑

### 6.1 验证规则

1. **报告名称验证**:
   - 必填
   - 长度：8-20个字符
   - 字符类型：支持中文、英文、数字、常用符号

2. **品牌选择验证**:
   - 至少选择1个品牌
   - 品牌ID必须存在于 `qiangua_brand` 表中

3. **笔记数量验证**:
   - 至少要有1条符合条件的笔记
   - 计算完成后才能提交

### 6.2 创建流程

1. **验证输入**:
   - 验证报告名称格式
   - 验证品牌选择
   - 验证笔记数量

2. **创建报告记录**:
   - 插入 `reports` 表记录
   - 获取生成的 `ReportId`

3. **批量导入笔记**:
   - 查询符合条件的笔记
   - 批量插入 `report_notes` 表（状态为 `active`）
   - 使用事务确保一致性

4. **返回结果**:
   - 返回报告ID和导入的笔记数量

### 6.3 批量导入优化

**分批处理**:
- 如果笔记数量较大（>1000条），分批插入
- 每批1000条，避免单次事务过大

**去重处理**:
- 使用 `ON CONFLICT (ReportId, NoteId) DO NOTHING` 防止重复
- 虽然理论上不应该重复，但添加保护措施

---

## 7. 追加笔记逻辑

### 7.1 验证规则

1. **品牌选择验证**:
   - 至少选择1个品牌

2. **增量笔记数量验证**:
   - 至少要有1条新增笔记
   - 计算完成后才能提交

### 7.2 追加流程

1. **验证输入**:
   - 验证品牌选择
   - 验证增量笔记数量

2. **查询增量笔记**:
   - 查询符合条件且不在报告中的笔记
   - 排除已在报告中的笔记（无论状态）

3. **批量插入**:
   - 批量插入 `report_notes` 表（状态为 `active`）
   - 使用 `ON CONFLICT` 处理重复（理论上不应该发生）

4. **返回结果**:
   - 返回成功添加的笔记数量和跳过的数量

---

## 8. 错误处理

### 8.1 验证错误

- **参数验证失败**: 返回400错误，提示具体验证失败原因
- **业务规则验证失败**: 返回400错误，提示业务规则违反原因

### 8.2 数据错误

- **报告不存在**: 返回404错误
- **笔记不存在**: 返回404错误（追加笔记时）
- **权限不足**: 返回403错误

### 8.3 系统错误

- **数据库错误**: 返回500错误，记录错误日志
- **网络错误**: 返回500错误，提示用户稍后重试

---

## 9. 性能优化

### 9.1 查询优化

- 使用索引优化常用查询
- 使用复合索引优化组合查询
- 避免全表扫描

### 9.2 批量操作优化

- 使用事务确保一致性
- 分批处理大量数据
- 使用 `ON CONFLICT` 处理重复

### 9.3 缓存策略

- 报告列表缓存（5分钟）
- 品牌列表缓存（10分钟）
- 统计信息缓存（1分钟）

---

## 10. 注意事项

1. **数据一致性**: 所有批量操作使用事务确保一致性
2. **去重处理**: 追加笔记时自动去重，避免重复添加
3. **状态管理**: 笔记状态变更时更新 `UpdatedAt` 字段
4. **权限控制**: 所有操作都需要验证用户权限
5. **错误处理**: 所有操作都要有完整的错误处理
6. **性能考虑**: 大量数据操作时使用分批处理

