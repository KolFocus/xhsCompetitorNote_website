# 数据库设计

## 概述

数据库设计用于存储从千瓜数据平台获取的笔记信息、品牌信息等数据。数据由独立的爬虫系统直接写入，本系统负责读取和分析。

## 表结构设计

### 表1：qiangua_note_info（千瓜笔记信息表）

存储从千瓜平台获取的笔记详细信息。

#### 字段说明

| 字段名 | 类型 | 说明 | 约束 | 索引 |
|--------|------|------|------|------|
| NoteId | VARCHAR(64) | 笔记ID（主键） | PRIMARY KEY, NOT NULL | PRIMARY KEY |
| DateCode | VARCHAR(64) | 日期代码（格式：YYYYMMDD） | NOT NULL | INDEX |
| NoteIdKey | VARCHAR(50) | 笔记ID密钥 | | |
| Title | TEXT | 笔记标题 | | |
| Content | TEXT | 笔记内容（完整文本） | | |
| CoverImage | TEXT | 封面图片URL | | |
| XhsNoteUrl | TEXT | 小红书笔记链接 | | |
| NoteType | VARCHAR(50) | 笔记类型（video/image） | | |
| IsBusiness | BOOLEAN | 是否商业笔记 | DEFAULT false | |
| IsAdNote | BOOLEAN | 是否广告笔记 | DEFAULT false | |
| PublishTime | TIMESTAMPTZ | 发布时间（带时区） | NOT NULL | INDEX |
| PubDate | DATE | 发布日期 | | INDEX |
| LikedCount | INTEGER | 点赞数 | DEFAULT 0 | |
| CollectedCount | INTEGER | 收藏数 | DEFAULT 0 | |
| CommentsCount | INTEGER | 评论数 | DEFAULT 0 | |
| ViewCount | INTEGER | 浏览数 | DEFAULT 0 | |
| ShareCount | INTEGER | 分享数 | DEFAULT 0 | |
| LikeCollect | INTEGER | 点赞+收藏总数 | DEFAULT 0 | |
| SpreadScore | DECIMAL(10,2) | 传播分数 | | |
| Index | DECIMAL(10,2) | 指数分数 | | |
| Lcc | INTEGER | LCC值 | | |
| VideoDuration | VARCHAR(20) | 视频时长 | | |
| Props | INTEGER | 属性值 | DEFAULT 0 | |
| BloggerId | VARCHAR(64) | 博主ID（外键） | NOT NULL, REFERENCES qiangua_blogger(BloggerId) | INDEX |
| BloggerNickName | VARCHAR(200) | 博主昵称（冗余字段，保留笔记发布时的快照） | | |
| BloggerProp | VARCHAR(100) | 博主属性（冗余字段，保留笔记发布时的快照） | | |
| BloggerTags | TEXT | 博主标签（冗余字段，保留笔记发布时的快照） | | |
| BloggerTagName | VARCHAR(200) | 博主标签名称（冗余字段，保留笔记发布时的快照） | | |
| Fans | INTEGER | 博主粉丝数（冗余字段，保留笔记发布时的快照） | DEFAULT 0 | |
| LevelNumber | INTEGER | 博主等级编号（冗余字段，保留笔记发布时的快照） | DEFAULT 0 | |
| LevelName | VARCHAR(100) | 博主等级名称（冗余字段，保留笔记发布时的快照） | | |
| Gender | INTEGER | 博主性别（冗余字段，保留笔记发布时的快照，0-未知，1-男，2-女） | DEFAULT 0 | |
| Location | VARCHAR(200) | 博主位置（冗余字段，保留笔记发布时的快照） | | |
| BigAvatar | TEXT | 博主大头像URL（冗余字段，保留笔记发布时的快照） | | |
| SmallAvatar | TEXT | 博主小头像URL（冗余字段，保留笔记发布时的快照） | | |
| McnName | TEXT | 博主MCN名称（冗余字段，保留笔记发布时的快照） | | |
| McnInfoId | VARCHAR(64) | 博主MCN信息ID（冗余字段，保留笔记发布时的快照） | | |
| IsBrandPartner | BOOLEAN | 博主是否品牌合作伙伴（冗余字段，保留笔记发布时的快照） | DEFAULT false | |
| OfficialVerified | BOOLEAN | 博主是否官方认证（冗余字段，保留笔记发布时的快照） | DEFAULT false | |
| GoodsCount | INTEGER | 博主商品数量（冗余字段，保留笔记发布时的快照） | DEFAULT 0 | |
| NoteActiveCount | INTEGER | 博主笔记活跃数（冗余字段，保留笔记发布时的快照） | DEFAULT 0 | |
| AdPrice | INTEGER | 博主广告报价（冗余字段，保留笔记发布时的快照，单位：分） | | |
| AdPriceUpdateStatus | INTEGER | 博主广告报价更新状态（冗余字段，保留笔记发布时的快照） | DEFAULT 0 | |
| PriceType | VARCHAR(50) | 博主价格类型（冗余字段，保留笔记发布时的快照） | | |
| LinkInfo | TEXT | 博主联系信息（冗余字段，保留笔记发布时的快照） | | |
| CooperateBindsName | TEXT | 合作绑定名称 | | |
| CooperateBindList | JSONB | 合作品牌列表（JSON数组） | | |
| BrandId | VARCHAR(64) | 品牌ID（从CooperateBindList第一个元素提取，外键关联qiangua_brand.BrandId） | REFERENCES qiangua_brand(BrandId) | INDEX |
| BrandIdKey | VARCHAR(50) | 品牌ID密钥（从CooperateBindList第一个元素提取） | | |
| BrandName | VARCHAR(200) | 品牌名称（从CooperateBindList第一个元素提取） | | |
| CurrentUserIsFavorite | BOOLEAN | 当前用户是否收藏 | DEFAULT false | |
| UpdateTime | TIMESTAMPTZ | 更新时间（带时区） | | INDEX |
| CreatedAt | TIMESTAMPTZ | 创建时间（带时区） | DEFAULT NOW() | |
| UpdatedAt | TIMESTAMPTZ | 更新时间（自动更新，带时区） | DEFAULT NOW() | |

#### 索引设计

- **主键索引**: `NoteId`
- **单列索引**: 
  - `DateCode` - 按日期查询
  - `PublishTime` - 按发布时间排序
  - `PubDate` - 按发布日期查询
  - `BloggerId` - 关联博主信息
  - `BrandId` - 按品牌查询
  - `UpdateTime` - 按更新时间查询
- **复合索引**:
  - `(DateCode, PublishTime)` - 按日期和时间查询
  - `(IsBusiness, PublishTime)` - 商业笔记查询
  - `(BloggerId, PublishTime)` - 博主笔记查询
  - `(BrandId, PublishTime)` - 品牌笔记查询

#### 约束条件

- `NoteId` 主键，唯一
- `DateCode` 不能为空
- `PublishTime` 不能为空
- `BloggerId` 不能为空，外键关联 `qiangua_blogger.BloggerId`
- `BrandId` 可为空，如果存在则外键关联 `qiangua_brand.BrandId`
- `BrandIdKey` 可为空（从 CooperateBindList 提取，如果不存在则为空）
- `BrandName` 可为空（从 CooperateBindList 提取，如果不存在则为空）

---

### 表2：qiangua_brand（千瓜品牌表）

存储品牌相关信息。

#### 字段说明

| 字段名 | 类型 | 说明 | 约束 | 索引 |
|--------|------|------|------|------|
| BrandId | VARCHAR(64) | 品牌ID（主键） | PRIMARY KEY, NOT NULL | PRIMARY KEY |
| BrandIdKey | VARCHAR(50) | 品牌ID密钥 | UNIQUE, NOT NULL | UNIQUE INDEX |
| BrandName | VARCHAR(200) | 品牌名称 | NOT NULL | INDEX |
| BrandDescription | TEXT | 品牌描述 | | |
| BrandLogo | TEXT | 品牌Logo URL | | |
| CreatedAt | TIMESTAMPTZ | 创建时间（带时区） | DEFAULT NOW() | |
| UpdatedAt | TIMESTAMPTZ | 更新时间（自动更新，带时区） | DEFAULT NOW() | |

#### 索引设计

- **主键索引**: `BrandId`
- **唯一索引**: `BrandIdKey`
- **单列索引**: 
  - `BrandName` - 按品牌名称查询

#### 约束条件

- `BrandId` 主键，唯一
- `BrandIdKey` 唯一，不能为空
- `BrandName` 不能为空

---

### 表3：qiangua_blogger（千瓜博主表）

存储博主相关信息。

#### 字段说明

| 字段名 | 类型 | 说明 | 约束 | 索引 |
|--------|------|------|------|------|
| BloggerId | VARCHAR(64) | 博主ID（主键） | PRIMARY KEY, NOT NULL | PRIMARY KEY |
| BloggerIdKey | VARCHAR(50) | 博主ID密钥 | UNIQUE, NOT NULL | UNIQUE INDEX |
| BloggerNickName | VARCHAR(200) | 博主昵称 | NOT NULL | INDEX |
| BloggerProp | VARCHAR(100) | 博主属性（如：腰部达人） | | |
| BloggerTags | TEXT | 博主标签（逗号分隔） | | |
| BloggerTagName | VARCHAR(200) | 博主标签名称 | | |
| Fans | INTEGER | 粉丝数 | DEFAULT 0 | INDEX |
| LevelNumber | INTEGER | 等级编号 | DEFAULT 0 | |
| LevelName | VARCHAR(100) | 等级名称（如：金冠薯） | | |
| Gender | INTEGER | 性别（0-未知，1-男，2-女） | DEFAULT 0 | |
| Location | VARCHAR(200) | 位置 | | |
| BigAvatar | TEXT | 博主大头像URL | | |
| SmallAvatar | TEXT | 博主小头像URL | | |
| McnName | TEXT | MCN名称 | | |
| McnInfoId | VARCHAR(64) | MCN信息ID | | |
| IsBrandPartner | BOOLEAN | 是否品牌合作伙伴 | DEFAULT false | |
| OfficialVerified | BOOLEAN | 是否官方认证 | DEFAULT false | |
| GoodsCount | INTEGER | 商品数量 | DEFAULT 0 | |
| NoteActiveCount | INTEGER | 笔记活跃数 | DEFAULT 0 | |
| AdPrice | INTEGER | 广告报价（分） | | |
| AdPriceUpdateStatus | INTEGER | 广告报价更新状态 | DEFAULT 0 | |
| PriceType | VARCHAR(50) | 价格类型（如：实时报价） | | |
| LinkInfo | TEXT | 联系信息（邮箱等） | | |
| CreatedAt | TIMESTAMPTZ | 创建时间（带时区） | DEFAULT NOW() | |
| UpdatedAt | TIMESTAMPTZ | 更新时间（自动更新，带时区） | DEFAULT NOW() | |

#### 索引设计

- **主键索引**: `BloggerId`
- **唯一索引**: `BloggerIdKey`
- **单列索引**: 
  - `BloggerNickName` - 按博主昵称查询
  - `Fans` - 按粉丝数排序

#### 约束条件

- `BloggerId` 主键，唯一
- `BloggerIdKey` 唯一，不能为空
- `BloggerNickName` 不能为空

---

## 表关系说明

### qiangua_note_info 与 qiangua_blogger 的关系

- **关系类型**: 多对一（Many-to-One）
- **实现方式**: 通过 `qiangua_note_info.BloggerId` 外键关联到 `qiangua_blogger.BloggerId`
- **关系说明**: 
  - 一个博主可以发布多条笔记
  - 每条笔记只能属于一个博主
  - 通过外键约束保证数据一致性

### qiangua_note_info 与 qiangua_brand 的关系

- **关系类型**: 多对一（Many-to-One）
- **实现方式**: 通过 `qiangua_note_info.BrandId` 外键关联到 `qiangua_brand.BrandId`
- **关系说明**: 
  - 一条笔记只能关联一个品牌（提取 `CooperateBindList` 的第一个元素）
  - 一个品牌可以关联多条笔记
  - 虽然 API 返回的 `CooperateBindList` 是数组格式，支持多对多关系，但在本系统中统一整理为多对一关系
- **数据来源**: 
  - `qiangua_note_info` 表中的 `BrandId`、`BrandIdKey`、`BrandName` 字段从 `CooperateBindList` JSONB 数组的第一个元素中提取
  - 如果 `CooperateBindList` 为空或不存在，这三个字段为 NULL
  - 这些字段用于快速查询和关联，避免每次都需要解析 JSONB 字段
- **JSON结构示例**:
  ```json
  [
    {
      "BrandId": 46899,
      "BrandIdKey": "ede74d",
      "BrandName": "Ralph Lauren拉夫劳伦"
    }
  ]
  ```
  **注意**: API返回的 `BrandId` 为 INTEGER 类型，存储到数据库时需要转换为 VARCHAR(64) 字符串类型。

---

## 数据类型说明

### PostgreSQL 类型映射

- `VARCHAR(n)`: 用于存储可变长度字符串（如笔记ID、博主ID、品牌ID等）
- `BIGINT`: 用于存储大整数（如计数、状态码）
- `INTEGER`: 用于存储普通整数（如计数、状态码）
- `TEXT`: 用于存储长文本（如笔记标题、内容、URL等）
- `TIMESTAMPTZ` (TIMESTAMP WITH TIME ZONE): 用于存储时间戳（带时区），推荐使用
- `DATE`: 用于存储日期
- `BOOLEAN`: 用于存储布尔值
- `DECIMAL(p,s)`: 用于存储精确小数
- `JSONB`: 用于存储JSON数据（支持索引和查询）

---

## RLS（行级安全）策略

### qiangua_note_info 表

```sql
-- 启用RLS
ALTER TABLE qiangua_note_info ENABLE ROW LEVEL SECURITY;

-- 策略：所有认证用户可读
CREATE POLICY "Users can read notes"
  ON qiangua_note_info
  FOR SELECT
  USING (auth.role() = 'authenticated');

-- 策略：仅服务角色可写（由爬虫系统写入）
CREATE POLICY "Service role can write notes"
  ON qiangua_note_info
  FOR INSERT
  USING (auth.role() = 'service_role');
```

### qiangua_brand 表

```sql
-- 启用RLS
ALTER TABLE qiangua_brand ENABLE ROW LEVEL SECURITY;

-- 策略：所有认证用户可读
CREATE POLICY "Users can read brands"
  ON qiangua_brand
  FOR SELECT
  USING (auth.role() = 'authenticated');

-- 策略：仅服务角色可写
CREATE POLICY "Service role can write brands"
  ON qiangua_brand
  FOR INSERT
  USING (auth.role() = 'service_role');
```

### qiangua_blogger 表

```sql
-- 启用RLS
ALTER TABLE qiangua_blogger ENABLE ROW LEVEL SECURITY;

-- 策略：所有认证用户可读
CREATE POLICY "Users can read bloggers"
  ON qiangua_blogger
  FOR SELECT
  USING (auth.role() = 'authenticated');

-- 策略：仅服务角色可写
CREATE POLICY "Service role can write bloggers"
  ON qiangua_blogger
  FOR INSERT
  USING (auth.role() = 'service_role');
```

---

## 数据同步说明

- **数据来源**: 独立的爬虫系统
- **写入方式**: 爬虫系统直接写入Supabase数据库
- **更新频率**: 根据爬虫系统配置
- **数据去重**: 通过 `NoteId` 主键保证唯一性
- **更新策略**: 使用 `ON CONFLICT` 语句实现 upsert 操作

### 注意事项

- **PostgreSQL 大小写敏感**: 使用 PascalCase 字段名时，需要在 SQL 语句中使用双引号包裹字段名，例如：`SELECT "NoteId", "Title" FROM qiangua_note_info`
- **Supabase 客户端**: Supabase 客户端会自动处理字段名的大小写转换，但直接使用 SQL 时需要注意双引号
- **CooperateBindList 字段提取**: 在数据同步时，需要从 `CooperateBindList` JSONB 数组中提取第一个元素（如果存在），将其 `BrandId`、`BrandIdKey`、`BrandName` 分别填充到对应的字段中
- **博主信息同步**: 在同步笔记数据时，需要先同步博主信息到 `qiangua_blogger` 表，然后再同步笔记信息，以保证外键约束的有效性
- **冗余字段设计**: `qiangua_note_info` 表中的 `BloggerId`、`BloggerNickName`、`BloggerProp`、`BloggerTags`、`BloggerTagName` 以及 `Fans`、`LevelNumber`、`LevelName`、`Gender`、`Location`、`BigAvatar`、`SmallAvatar`、`McnName`、`McnInfoId`、`IsBrandPartner`、`OfficialVerified`、`GoodsCount`、`NoteActiveCount`、`AdPrice`、`AdPriceUpdateStatus`、`PriceType`、`LinkInfo` 等字段为冗余字段，用于存储博主在笔记发布时的快照数据。这些字段的值在笔记同步时从API接口获取并保存，不会随 `qiangua_blogger` 表的更新而更新。这样设计的好处是：
  - 方便查询：无需关联 `qiangua_blogger` 表即可获取博主信息
  - 保留历史：可以查看博主在笔记发布时的粉丝数、价格等数据，这些数据可能会随时间变化
  - 性能优化：减少JOIN操作，提高查询效率

---

## 查询优化建议

1. **分页查询**: 使用 `LIMIT` 和 `OFFSET` 或基于游标的分页
2. **时间范围查询**: 使用 `DateCode` 或 `PublishTime` 索引
3. **全文搜索**: 对 `Title` 和 `Content` 字段考虑使用 PostgreSQL 全文搜索
4. **JSON查询**: 对 `CooperateBindList` JSONB 字段使用 GIN 索引优化查询

---

## 后续扩展

1. **标签表**: 可考虑将标签信息独立成表，建立多对多关系
2. **分析结果表**: 存储AI分析结果（内容类别、单品名称等）
3. **用户收藏表**: 存储用户收藏的笔记（关联用户表）

