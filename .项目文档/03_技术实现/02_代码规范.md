# 代码规范

## TypeScript规范

### 类型定义
- 所有函数参数和返回值必须有类型定义
- 使用interface定义对象类型
- 使用type定义联合类型和工具类型
- 避免使用any，优先使用unknown

### 命名规范
- **变量**: 使用camelCase（驼峰命名）
- **常量**: 使用UPPER_SNAKE_CASE（大写下划线）
- **组件**: 使用PascalCase（帕斯卡命名）
- **文件**: 使用kebab-case（短横线命名）或camelCase

### 示例
```typescript
// 变量
const userName = 'admin';
const userCount = 10;

// 常量
const API_BASE_URL = 'https://api.example.com';
const MAX_RETRY_COUNT = 3;

// 组件
const UserProfile: React.FC<UserProfileProps> = () => { };

// 类型定义
interface User {
  id: string;
  name: string;
  email: string;
}
```

## React组件规范

### 组件结构
```typescript
// 1. 导入依赖
import React from 'react';
import { Button } from 'antd';

// 2. 类型定义
interface ComponentProps {
  title: string;
  onClick: () => void;
}

// 3. 组件定义
const Component: React.FC<ComponentProps> = ({ title, onClick }) => {
  // 4. Hooks
  const [state, setState] = useState<string>('');
  
  // 5. 事件处理函数
  const handleClick = () => {
    onClick();
  };
  
  // 6. 渲染
  return (
    <div>
      <h1>{title}</h1>
      <Button onClick={handleClick}>Click</Button>
    </div>
  );
};

// 7. 导出
export default Component;
```

### Hooks使用规范
- 自定义Hooks以`use`开头
- Hooks必须在组件顶层调用
- 不要在循环、条件语句中调用Hooks

### 组件注释
```typescript
/**
 * 用户资料组件
 * @param userId - 用户ID
 * @param onUpdate - 更新回调函数
 */
const UserProfile: React.FC<Props> = ({ userId, onUpdate }) => {
  // 实现...
};
```

## 文件组织规范

### 目录结构
```
components/
  ├── layout/          # 布局组件
  │   └── Sidebar.tsx
  ├── common/          # 通用组件
  │   └── Button.tsx
  └── business/        # 业务组件
      └── NoteCard.tsx

lib/
  ├── supabase/        # Supabase相关
  │   └── client.ts
  ├── utils/           # 工具函数
  │   └── format.ts
  └── types/           # 类型定义
      └── index.ts
```

### 文件命名
- 组件文件：PascalCase（如 `UserProfile.tsx`）
- 工具文件：camelCase（如 `formatDate.ts`）
- 配置文件：kebab-case（如 `next.config.js`）

## 代码复杂度规范

### 行数限制规则
为保持代码可读性和可维护性，设定以下行数限制：

1. **源文件行数限制：500行**
   - 单个源文件的有效代码行数（不含空行和注释）不得超过500行
   - 超过限制必须拆分为多个文件

2. **函数行数限制：80行**
   - 单个函数的有效代码行数（不含空行和注释）不得超过80行
   - 超过限制必须拆分为多个小函数

### 统计方式说明
- **不包含**：空行、单行注释（`//`）、多行注释（`/* */`）、JSDoc注释
- **包含**：所有可执行代码行、类型定义、导入导出语句

### 拆分原则
当文件或函数超过限制时，按以下原则进行拆分：

1. **按功能模块拆分**：将不同功能模块拆分为独立文件或函数
2. **按职责单一性拆分**：确保拆分后的文件或函数职责单一、边界清晰
3. **提取公共逻辑**：将重复或通用逻辑提取为独立的工具函数
4. **保持接口稳定**：拆分时尽量保持对外接口不变，降低影响范围

### 拆分示例

#### 文件拆分示例
```typescript
// ❌ 错误：文件超过500行
// UserManagement.ts (600行有效代码)

// ✅ 正确：拆分为多个文件
// UserManagement.ts (核心逻辑，200行)
// UserList.tsx (列表组件，150行)
// UserForm.tsx (表单组件，150行)
// UserTypes.ts (类型定义，50行)
// UserUtils.ts (工具函数，100行)
```

#### 函数拆分示例
```typescript
// ❌ 错误：函数超过80行
function processUserData(user: User): ProcessedUser {
  // 验证逻辑（20行）
  // 数据处理逻辑（30行）
  // 格式化逻辑（25行）
  // 返回结果（10行）
  // 总计：85行
}

// ✅ 正确：拆分为多个小函数
function validateUser(user: User): ValidationResult {
  // 验证逻辑（20行）
}

function transformUserData(user: User): TransformedData {
  // 数据处理逻辑（30行）
}

function formatUserData(data: TransformedData): ProcessedUser {
  // 格式化逻辑（25行）
}

function processUserData(user: User): ProcessedUser {
  const validation = validateUser(user);
  if (!validation.valid) throw new Error(validation.error);
  
  const transformed = transformUserData(user);
  return formatUserData(transformed);
}
```

### 例外情况
以下情况可以不遵循行数限制，但需要添加注释说明原因：

1. **自动生成的代码**：由工具自动生成的代码（如API客户端、类型定义等）
   ```typescript
   // 自动生成：此文件由代码生成工具生成，请勿手动编辑
   // 生成时间：2024-01-01
   ```

2. **复杂但不可拆分的逻辑**：某些算法或业务逻辑虽然较长，但拆分会影响理解
   ```typescript
   /**
    * 复杂状态机处理逻辑
    * 说明：此函数包含完整的状态转换逻辑，拆分会影响状态管理的一致性
    * 行数：95行（超出限制但保留）
    */
   function processStateMachine(state: State, event: Event): State {
     // 状态机逻辑...
   }
   ```

3. **数据定义文件**：包含大量静态数据或配置的文件
   ```typescript
   // 配置数据：包含完整的业务配置映射表
   // 行数：600行（数据定义，保留完整结构）
   export const CONFIG_MAP = {
     // ...
   };
   ```

4. **测试文件**：测试文件中包含大量测试用例时，允许适当放宽限制

### 检查工具
建议在CI/CD流程中集成代码行数检查：
- 使用ESLint插件或自定义脚本统计有效代码行数
- 在Pull Request时自动检查并提醒

## 代码格式化

### ESLint规则
- 使用Next.js推荐的ESLint配置
- 禁止console.log（生产环境）
- 强制使用===而不是==

### Prettier配置
- 单引号
- 2空格缩进
- 末尾逗号
- 行宽100字符

## 错误处理

### 异步错误处理
```typescript
try {
  const result = await fetchData();
  return result;
} catch (error) {
  console.error('Error fetching data:', error);
  throw error;
}
```

### 错误边界
```typescript
// 使用React Error Boundary处理组件错误
<ErrorBoundary fallback={<ErrorFallback />}>
  <Component />
</ErrorBoundary>
```

## 性能优化规范

### 避免不必要的重渲染
- 使用React.memo包装纯组件
- 使用useMemo缓存计算结果
- 使用useCallback缓存函数引用

### 代码分割
- 使用动态导入（dynamic import）
- 路由级别的代码分割（Next.js自动处理）

### 示例
```typescript
// 动态导入
const HeavyComponent = dynamic(() => import('./HeavyComponent'), {
  loading: () => <Loading />,
});

// useMemo
const expensiveValue = useMemo(() => {
  return computeExpensiveValue(data);
}, [data]);

// useCallback
const handleClick = useCallback(() => {
  doSomething();
}, [dependency]);
```

## 注释规范

### 函数注释
```typescript
/**
 * 格式化日期
 * @param date - 日期对象或日期字符串
 * @param format - 格式化模板，默认 'YYYY-MM-DD'
 * @returns 格式化后的日期字符串
 */
function formatDate(date: Date | string, format = 'YYYY-MM-DD'): string {
  // 实现...
}
```

### 复杂逻辑注释
```typescript
// 计算笔记评分
// 评分规则：
// 1. 点赞数权重: 40%
// 2. 收藏数权重: 30%
// 3. 评论数权重: 20%
// 4. 分享数权重: 10%
const score = calculateNoteScore(note);
```

## Git提交规范

### 提交信息格式
```
<type>(<scope>): <subject>

<body>

<footer>
```

### Type类型
- feat: 新功能
- fix: 修复bug
- docs: 文档更新
- style: 代码格式
- refactor: 重构
- test: 测试
- chore: 构建/工具

### 示例
```
feat(auth): 添加登录功能

实现了基于Supabase的邮箱密码登录功能
包含表单验证和错误处理
```

