# 代码结构说明

## 目录结构

```
/
├── app/                          # Next.js App Router目录
│   ├── layout.tsx               # 根布局（配置antd和全局样式）
│   ├── globals.css              # 全局样式
│   ├── (auth)/                  # 认证路由组
│   │   └── login/
│   │       └── page.tsx         # 登录/注册页面（Tab切换）
│   └── dashboard/               # 主应用路由（需要认证）
│       ├── layout.tsx           # 主应用布局（顶部导航+侧边栏）
│       ├── page.tsx             # 首页/仪表盘
│       ├── notes/               # 笔记管理模块
│       │   ├── page.tsx         # 全部笔记
│       │   └── favorites/
│       │       └── page.tsx     # 我的收藏
│       ├── brands/              # 品牌管理模块
│       │   ├── page.tsx         # 品牌列表
│       │   └── add/
│       │       └── page.tsx     # 添加品牌
│       ├── reports/             # 分析报告模块
│       │   ├── page.tsx         # 数据概览
│       │   └── trends/
│       │       └── page.tsx     # 趋势分析
│       └── settings/            # 设置模块
│           ├── page.tsx         # 个人设置
│           └── system/
│               └── page.tsx     # 系统设置
│
├── components/                  # 可复用组件目录
│   └── layout/
│       └── SidebarMenu.tsx      # 侧边栏菜单组件
│
├── lib/                         # 工具函数和配置目录
│   ├── supabase/
│   │   ├── client.ts            # 客户端Supabase客户端
│   │   └── server.ts            # 服务端Supabase客户端
│   ├── utils/
│   │   └── menuConfig.tsx       # 菜单配置和工具函数
│   └── types/
│       └── index.ts              # 全局类型定义
│
├── middleware.ts                 # Next.js中间件（路由保护）
├── package.json                  # 项目依赖配置
├── tsconfig.json                 # TypeScript配置
├── next.config.js                # Next.js配置
└── .项目文档/                    # 项目文档目录
```

## API 路由（关键）

```
app/api/
  bloggers/route.ts
  brands/route.ts
  notes/route.ts
  notes/stats/route.ts
  data/init-test-data/route.ts
  reports/route.ts
  reports/calculate-notes/route.ts
  reports/[id]/route.ts
  reports/[id]/add-notes/route.ts
  reports/[id]/calculate-new-notes/route.ts
  reports/[id]/notes/route.ts
  reports/[id]/notes/batch-action/route.ts
  reports/[id]/blogger-matrix/config/route.ts
  reports/[id]/blogger-matrix/stats/route.ts
```

## 业务组件（关键）

```
components/reports/
  CreateReportModal.tsx
  AddNotesModal.tsx
  BloggerMatrixAnalysis.tsx
  BloggerMatrixConfigModal.tsx
```

## 对齐说明（与实现一致性核对）
- 主应用目录为 `app/dashboard/*`（不含路由组括号），文档已修正。
- 达人矩阵配置存储字段为 `qiangua_report.CustomLevels`，统计接口按该配置或默认分层计算。
- 达人矩阵“总互动量”= 点赞 + 收藏 + 评论（不含分享）；分享独立统计并展示。
- 达人矩阵组件提供“配置”“导出Excel”两个操作按钮。

## 关键文件说明

### 路由和布局

- **app/layout.tsx**: 根布局，配置antd ConfigProvider和全局样式
- **app/(auth)/login/page.tsx**: 登录/注册页面，使用Tab切换
- **app/(dashboard)/layout.tsx**: 主应用布局，包含顶部导航栏和可收起的侧边栏

### 组件

- **components/layout/SidebarMenu.tsx**: 
  - 侧边栏菜单组件
  - 支持二级菜单
  - 支持收起/展开
  - 收起时显示Tooltip和Popover子菜单

### 工具函数

- **lib/supabase/client.ts**: 客户端Supabase客户端创建函数
- **lib/supabase/server.ts**: 服务端Supabase客户端创建函数
- **lib/utils/menuConfig.tsx**: 菜单配置、路由映射、选中状态计算

### 中间件

- **middleware.ts**: 
  - 路由保护
  - 检查用户认证状态
  - 未登录用户访问/dashboard重定向到/login
  - 已登录用户访问/login重定向到/dashboard

## 路由规则

### 公开路由
- `/login` - 登录/注册页面

### 受保护路由（需要认证）
- `/dashboard` - 首页
- `/dashboard/notes` - 全部笔记
- `/dashboard/notes/favorites` - 我的收藏
- `/dashboard/brands` - 品牌列表
- `/dashboard/brands/add` - 添加品牌
- `/dashboard/reports` - 数据概览
- `/dashboard/reports/trends` - 趋势分析
- `/dashboard/settings` - 个人设置
- `/dashboard/settings/system` - 系统设置

## 组件设计模式

### Server Components vs Client Components

- **Server Components**: 默认，用于数据获取和静态内容
- **Client Components**: 使用 `'use client'` 指令，用于交互和状态管理

### 状态管理

- 使用React Hooks（useState, useEffect）
- Context API用于全局状态（如用户认证）
- Server Components减少客户端状态管理需求

## 样式方案

- **antd组件**: 使用antd内置样式系统
- **CSS Modules**: 组件级样式隔离
- **globals.css**: 全局样式和重置样式

## 类型安全

- 所有组件使用TypeScript
- 定义interface和type确保类型安全
- lib/types/index.ts集中管理全局类型

## 认证流程

1. 用户在登录页输入邮箱密码
2. 调用Supabase Auth API进行认证
3. Supabase返回Session（存储在Cookie中）
4. middleware检查认证状态，保护路由
5. 客户端和服务端都可以访问认证状态

## 菜单配置

菜单配置集中在 `lib/utils/menuConfig.tsx`:
- menuItems: 菜单项配置数组
- findMenuItemByPath: 根据路径查找菜单项
- getSelectedKeys: 获取当前选中菜单key
- getOpenKeys: 获取当前打开的SubMenu key

