# 报告功能前端组件开发文档

## 概述

本文档描述报告功能相关的前端组件设计、状态管理和数据流。

---

## 组件列表

### 1. CreateReportModal（创建报告对话框）

**路径**: `components/reports/CreateReportModal.tsx`

**功能**: 创建新报告的对话框组件。

**Props**:

```typescript
interface CreateReportModalProps {
  open: boolean;
  onCancel: () => void;
  onSuccess: (reportId: string) => void;
}
```

**状态管理**:

```typescript
const [form] = Form.useForm();
const [brandIds, setBrandIds] = useState<string[]>([]);
const [dateRange, setDateRange] = useState<[Dayjs, Dayjs] | null>(null);
const [notesCount, setNotesCount] = useState<number | null>(null);
const [calculating, setCalculating] = useState(false);
const [loading, setLoading] = useState(false);
```

**核心逻辑**:

1. **动态计算笔记数量**:
   - 当品牌选择或时间范围变化时，调用 `/api/reports/calculate-notes` 接口
   - 计算过程中禁用按钮，显示"正在计算..."提示
   - 计算完成后显示笔记数量并恢复按钮

2. **表单验证**:
   - 报告名称：8-20个字符
   - 品牌选择：至少选择1个品牌
   - 按钮可用条件：报告名称已填写且至少1个品牌，且计算完成，且至少1条笔记

3. **提交创建**:
   - 调用 `/api/reports` 接口创建报告
   - 成功后关闭对话框并调用 `onSuccess` 回调

**关键代码片段**:

```typescript
// 计算笔记数量
const handleCalculateNotes = useCallback(async () => {
  if (brandIds.length === 0) {
    setNotesCount(null);
    return;
  }
  
  setCalculating(true);
  try {
    const response = await fetch('/api/reports/calculate-notes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        brandIds,
        startDate: dateRange?.[0]?.format('YYYY-MM-DD'),
        endDate: dateRange?.[1]?.format('YYYY-MM-DD'),
      }),
    });
    const data = await response.json();
    if (data.success) {
      setNotesCount(data.data.totalCount);
    }
  } catch (error) {
    message.error('计算笔记数量失败');
  } finally {
    setCalculating(false);
  }
}, [brandIds, dateRange]);

// 监听品牌和时间范围变化
useEffect(() => {
  handleCalculateNotes();
}, [handleCalculateNotes]);
```

---

### 2. AddNotesModal（追加笔记对话框）

**路径**: `components/reports/AddNotesModal.tsx`

**功能**: 追加笔记到现有报告的对话框组件。

**Props**:

```typescript
interface AddNotesModalProps {
  open: boolean;
  reportId: string;
  reportName: string;
  defaultBrandIds?: string[];
  onCancel: () => void;
  onSuccess: () => void;
}
```

**状态管理**:

```typescript
const [form] = Form.useForm();
const [brandIds, setBrandIds] = useState<string[]>(defaultBrandIds || []);
const [dateRange, setDateRange] = useState<[Dayjs, Dayjs] | null>(null);
const [newNotesCount, setNewNotesCount] = useState<number | null>(null);
const [calculating, setCalculating] = useState(false);
const [loading, setLoading] = useState(false);
```

**核心逻辑**:

1. **初始化默认值**:
   - 报告名称：只读显示
   - 品牌选择：默认选中报告内所有品牌（从 `defaultBrandIds` 获取）
   - 时间范围：默认留空

2. **动态计算增量笔记数量**:
   - 当品牌选择或时间范围变化时，调用 `/api/reports/[id]/calculate-new-notes` 接口
   - 计算符合条件且不在报告中的笔记数量（去重）

3. **提交追加**:
   - 调用 `/api/reports/[id]/add-notes` 接口追加笔记
   - 成功后关闭对话框并调用 `onSuccess` 回调刷新报告详情页

---

### 3. ReportDetailPage（报告详情页）

**路径**: `app/dashboard/reports/page.tsx`

**功能**: 报告详情页主组件，显示报告信息和笔记列表。

**状态管理**:

```typescript
const [reportId, setReportId] = useState<string | null>(null);
const [report, setReport] = useState<Report | null>(null);
const [reports, setReports] = useState<Report[]>([]);
const [notes, setNotes] = useState<Note[]>([]);
const [loading, setLoading] = useState(false);
const [filters, setFilters] = useState<FilterParams>({});
const [selectedNoteIds, setSelectedNoteIds] = useState<string[]>([]);
const [activeTab, setActiveTab] = useState<'active' | 'ignored'>('active');
```

**核心功能**:

1. **报告选择**:
   - 下拉列表显示所有报告（按创建时间倒序）
   - 默认选中最新创建的报告
   - 切换报告时刷新页面内容

2. **报告信息展示**:
   - 报告名称、创建时间、统计范围卡片
   - 有效笔记数、已忽略笔记数统计卡片

3. **笔记列表**:
   - Tab切换：有效笔记 / 已忽略
   - 筛选器：品牌、博主、日期范围
   - 搜索框：实时搜索笔记标题、品牌名称
   - 表格：支持排序、分页、批量操作

4. **批量操作**:
   - 全选/取消全选
   - 批量忽略（有效笔记tab）
   - 批量删除（有效笔记tab）
   - 批量恢复（已忽略tab）
5. **达人矩阵**:
   - 操作按钮："导出Excel"、"配置"
   - 导出包含两个sheet：汇总（按页面列顺序）与明细（参与统计的笔记全集）

---

### 4. ReportSelector（报告选择器）

**路径**: `components/reports/ReportSelector.tsx`

**功能**: 报告选择下拉框组件。

**Props**:

```typescript
interface ReportSelectorProps {
  value?: string;
  onChange: (reportId: string) => void;
  onAddNew?: () => void;
}
```

**核心逻辑**:

1. 加载报告列表（调用 `/api/reports`）
2. 显示报告名称下拉选择
3. 显示创建时间（右侧）
4. 提供"创建新报告"按钮

---

### 5. ReportNotesTable（报告笔记表格）

**路径**: `components/reports/ReportNotesTable.tsx`

**功能**: 报告笔记列表表格组件。

**Props**:

```typescript
interface ReportNotesTableProps {
  reportId: string;
  status: 'active' | 'ignored';
  filters: FilterParams;
  onRefresh?: () => void;
}
```

**核心功能**:

1. 加载笔记列表（调用 `/api/reports/[id]/notes`）
2. 支持排序（点赞、浏览、评论、分享、发布时间）
3. 支持分页
4. 支持批量选择
5. 操作列：忽略/删除/恢复按钮

---

### 6. BatchActionBar（批量操作栏）

**路径**: `components/reports/BatchActionBar.tsx`

**功能**: 批量操作工具栏组件。

**Props**:

```typescript
interface BatchActionBarProps {
  selectedCount: number;
  status: 'active' | 'ignored';
  onIgnore?: () => void;
  onDelete?: () => void;
  onRestore?: () => void;
}
```

**核心功能**:

1. 显示已选择笔记数量
2. 根据状态显示不同操作按钮：
   - 有效笔记tab：忽略、删除
   - 已忽略tab：恢复

---

## 状态管理

### 本地状态（useState）

- 组件内部状态使用 `useState` 管理
- 表单状态使用 `Form.useForm()` 管理

### 数据获取（useEffect）

- 使用 `useEffect` 在组件挂载时获取数据
- 使用 `useEffect` 监听筛选条件变化，重新获取数据

### 状态提升

- 报告选择状态提升到 `ReportDetailPage`
- 筛选条件状态提升到 `ReportDetailPage`

---

## 数据流

### 创建报告流程

```
用户输入 → CreateReportModal
  ↓
计算笔记数量 → POST /api/reports/calculate-notes
  ↓
显示笔记数量
  ↓
用户点击创建 → POST /api/reports
  ↓
创建成功 → 跳转到报告详情页
```

### 追加笔记流程

```
用户点击追加笔记 → AddNotesModal
  ↓
计算增量笔记数量 → POST /api/reports/[id]/calculate-new-notes
  ↓
显示增量笔记数量
  ↓
用户点击确认 → POST /api/reports/[id]/add-notes
  ↓
追加成功 → 刷新报告详情页
```

### 批量操作流程

```
用户选择笔记 → 更新 selectedNoteIds
  ↓
显示批量操作栏
  ↓
用户点击操作 → POST /api/reports/[id]/notes/batch-action
  ↓
操作成功 → 刷新笔记列表
```

---

## 组件通信

### 父子组件通信

- 使用 Props 传递数据和回调函数
- 使用 `onSuccess` 回调通知父组件操作成功

### 兄弟组件通信

- 通过状态提升到共同父组件
- 使用 Context API（如果需要在多个组件间共享状态）

---

## 样式规范

### 使用 antd 组件

- 遵循 antd 5.x 设计规范
- 使用 antd 的间距、颜色、字体等设计token

### 自定义样式

- 使用 CSS Modules 或 styled-components
- 避免内联样式（特殊情况除外）

---

## 性能优化

### 防抖/节流

- 搜索框输入使用防抖（300ms）
- 计算笔记数量使用节流（500ms）

### 缓存

- 报告列表缓存（避免频繁请求）
- 品牌列表缓存（避免重复请求）

### 懒加载

- 表格数据分页加载
- 图片懒加载

---

## 错误处理

### 统一错误处理

```typescript
try {
  const response = await fetch(url, options);
  const data = await response.json();
  
  if (!data.success) {
    message.error(data.error || '操作失败');
    return;
  }
  
  // 处理成功数据
} catch (error) {
  message.error('网络错误，请稍后重试');
}
```

### 加载状态

- 使用 `loading` 状态显示加载动画
- 使用 `Spin` 组件包裹异步操作区域

---

## 测试建议

### 单元测试

- 测试组件渲染
- 测试用户交互
- 测试表单验证

### 集成测试

- 测试API调用
- 测试数据流
- 测试错误处理

---

## 注意事项

1. **类型安全**: 所有组件使用 TypeScript，定义完整的类型
2. **错误处理**: 所有API调用都要有错误处理
3. **用户体验**: 提供清晰的加载状态和错误提示
4. **性能**: 避免不必要的重渲染
5. **可访问性**: 遵循无障碍设计规范

