---
标题: 达人矩阵属性分析功能规格
Owner: 产品（TBD）
状态: 已批准
Canonical: true
Links:
  业务规则: ../../05_核心业务逻辑/达人矩阵统计业务逻辑.md
  UI规格: ../../02_UI设计/02_原型与线框图/达人矩阵分析页面设计.md
  API规格: ../../03_技术实现/05_API接口契约/API_达人矩阵分析接口.md
  测试用例: ../../04_质量保证/02_测试用例/达人矩阵分析功能测试用例.md
---
# 达人矩阵属性分析功能规格

> 口径以“业务规则”文档为准，本文仅描述范围、用户诉求与验收标准。

## 1. 功能概述

达人矩阵属性分析功能用于对报告中的笔记达人进行分层统计和分析。通过将达人按照粉丝数量和官方认证状态进行分类，展示各层级达人的数量、互动量、笔记数量等关键指标，帮助用户了解报告中达人的分布情况。

**功能位置**：该功能是报告详情页的一个分析板块，位于报告相关笔记列表之上，作为报告分析的重要组成部分。

## 2. 核心功能

### 2.1 达人分层

- **知名KOL层**：固定层级，用于统计官方认证的达人，名称固定为"知名KOL"，不可禁用
- **自定义层级**：支持用户自定义多个层级，每个层级可配置：
  - 层级名称
  - 粉丝数范围（min/max，max可为空表示无上限）
  - 层级之间粉丝数范围严格不重叠
  - 范围边界规则：左闭右开区间 `[minFans, maxFans)`；当 `maxFans = null` 表示无上限，即 `Fans >= minFans`

### 2.2 统计展示

展示各层级达人的以下统计指标：
- 达人数量及占比
- 平均粉丝数
- 总互动量（点赞+收藏+评论，不含分享）及占比
- 笔记数量及占比

### 2.3 数据来源与统计方法

#### 数据来源

达人矩阵统计数据来源于报告关联的笔记数据，具体数据表如下：

1. **笔记数据表（qiangua_note_info）**：
   - 包含报告中的所有笔记记录
   - 每条笔记记录包含达人信息（BloggerId、Fans、OfficialVerified等）
   - 每条笔记记录包含互动数据（LikedCount、CollectedCount、CommentsCount、ShareCount）

2. **达人数据表（qiangua_blogger）**：
   - 存储达人的详细信息
   - 包含粉丝数（Fans）和官方认证状态（OfficialVerified）等字段
   - 作为达人信息的权威数据源（当笔记表中的达人信息需要更新时，可关联查询）

3. **报告笔记关联表（qiangua_report_note_rel）**：
   - 记录报告与笔记的关联关系
   - 用于确定哪些笔记属于当前报告

#### 统计方法

统计过程基于报告关联的所有笔记数据，按以下步骤进行：

1. **数据筛选**：
   - 从 `qiangua_report_note_rel` 表中获取当前报告的所有笔记ID
   - 关联 `qiangua_note_info` 表获取笔记详细信息和达人信息
   - 仅统计状态为"active"的笔记记录

2. **达人分层**：
   - **知名KOL层**：筛选 `OfficialVerified = true` 的达人（基于笔记表中的 `OfficialVerified` 字段）
   - **自定义层级**：根据配置的粉丝数范围，筛选 `Fans` 字段在指定范围内的达人（基于笔记表中的 `Fans` 字段）
   - 注意：同一达人可能出现在多个笔记中，统计时需要对达人进行去重处理

3. **指标计算**：
   - **达人数量**：统计该层级中不重复的达人数量（按 `BloggerId` 去重）
   - **达人占比**：该层级达人数量 /（知名KOL层 + 所有自定义层级的达人总数）× 100%（未分层达人不计入分母）
   - **平均粉丝数**：该层级所有达人的粉丝数总和 / 该层级达人数量（按达人去重后计算平均值）
   - **总互动量**：该层级所有笔记的互动量总和 = （LikedCount + CollectedCount + CommentsCount）之和（不含分享）
   - **互动量占比**：该层级总互动量 /（知名KOL层 + 所有自定义层级的总互动量）× 100%（未分层达人对应笔记的互动量不计入分母）
   - **笔记数量**：该层级达人的笔记总数（不去重）
   - **笔记占比**：该层级笔记数量 / 报告内笔记总数 × 100%
   - **分享**：独立统计其数值和占比（不计入“总互动量”）

4. **总计行统计**：
   - 基于报告中的所有有效笔记与达人集合进行汇总；分母口径用于分层行的占比时仅包含“知名KOL”与所有自定义层级，以保证各分层占比之和为 100%
   - **总计行指标计算**：
     - **层级名称**：显示"总计"
     - **粉丝数范围**：显示报告所有有效笔记对应的不重复达人中，粉丝数的最小值和最大值，格式：`最小值 - 最大值`（例如：`0.5万 - 120万`）
     - **达人数量**：报告所有有效笔记对应的不重复达人总数（按 `BloggerId` 去重）
     - **达人占比**：100.0%
     - **平均粉丝数**：报告所有有效笔记对应的不重复达人的平均粉丝数（按达人去重后计算）
     - **总互动量**：报告所有有效笔记的互动量总和（点赞+收藏+评论，不含分享）
     - **互动量占比**：100.0%
     - **笔记数量**：报告所有有效笔记的总数（所有active笔记的数量）
     - **笔记占比**：100.0%

5. **数据去重说明**：
   - 达人数量统计时，需要按 `BloggerId` 去重，确保每个达人只计算一次
   - 平均粉丝数计算时，需要先按达人去重，再计算平均值（避免同一达人的多条笔记影响平均值）
   - 笔记数量和互动量统计时，不去重，统计所有笔记记录（因为同一达人的多条笔记都应计入）

### 2.4 配置管理

- 支持查看和修改达人矩阵配置
- 支持添加、删除、编辑自定义层级
- 配置验证：确保层级名称唯一、范围不重叠、范围连续无留空、数值合理
- 支持重置为默认配置
- **配置加载逻辑（与实现一致）**：
  - 系统默认配置：代码内置（含固定“知名KOL”行与若干默认自定义层级）
  - 用户自定义配置：存储在 `qiangua_report.CustomLevels`（JSON，按报告ID关联）
  - 加载优先级：存在自定义配置则优先使用，否则回退默认配置

### 2.5 接口设计与计算方式

#### 接口设计

1. **获取达人分层配置接口**：
   - 接口返回当前报告的达人分层配置
   - 如果数据库中不存在该报告的配置，返回null或空，前端使用系统默认配置
   - 配置包含：知名KOL层（固定）和自定义层级列表

2. **保存达人分层配置接口**：
   - 保存用户自定义的达人分层配置到数据库
   - 配置按报告ID关联存储

3. **获取笔记列表接口**：
   - 接口返回当前报告的所有有效笔记（状态为"active"）
   - 笔记数据包含：笔记ID、达人ID、达人粉丝数、达人官方认证状态、互动数据等
   - 前端基于这些数据进行统计计算

#### 计算方式

- **后端计算**：统计数据由服务端接口计算并返回，前端负责展示和导出
- **计算时机**：页面加载、配置保存、有效笔记集合变化（追加/忽略/删除/恢复）
- **计算逻辑**：遵循本节定义的统计与分层规则

## 3. 功能流程

### 3.1 查看达人矩阵分析

1. 用户进入报告详情页
2. 在报告详情页顶部（笔记列表之上）查看"达人矩阵属性分析"板块
3. 系统调用接口获取：
   - 达人分层配置（如果不存在则使用系统默认配置）
   - 报告关联的所有有效笔记数据
4. 前端根据当前配置的层级规则，对达人进行分层统计计算
5. 展示各层级统计数据表格

### 3.2 配置层级

1. 用户点击"配置"按钮，打开配置弹窗
2. 系统加载配置：
   - 如果存在该报告的自定义配置，则加载自定义配置
   - 如果不存在，则加载系统默认配置（写在代码中）
3. 查看当前层级配置（知名KOL固定显示，不可编辑）
4. 对自定义层级进行以下操作：
   - **添加层级**：点击"添加层级"，输入层级名称和粉丝数范围
   - **编辑层级**：点击层级行的编辑按钮，修改层级名称或范围
   - **删除层级**：点击层级行的删除按钮（至少保留一个自定义层级）
5. 系统验证配置：
   - 层级名称不能为空且不能重复
   - 粉丝数范围不能重叠
   - 层级之间不能留空（所有粉丝数范围需连续覆盖）
   - 数值必须合理（min < max，或max为空）
6. 点击"保存"应用配置（保存到数据库），或点击"重置"恢复系统默认配置
7. 配置保存后，前端自动重新计算并刷新统计数据

### 3.3 数据刷新

统计数据在以下场景下需要重新计算：

1. **页面加载时**：
   - 用户进入报告详情页时，自动加载配置和笔记数据，完成计算

2. **配置修改后**：
   - 用户保存自定义配置后，前端自动重新计算统计数据

3. **报告数据更新后**（参考创建报告功能设计文档）：
   - **追加笔记**：用户通过"追加笔记"功能添加新笔记到报告后，需要重新计算
   - **忽略笔记**：用户将笔记标记为忽略状态后，有效笔记数量减少，需要重新计算
   - **删除笔记**：用户从报告中删除笔记后，有效笔记数量减少，需要重新计算
   - **恢复笔记**：用户恢复被忽略或删除的笔记后，有效笔记数量增加，需要重新计算

4. **切换报告时**：
   - 用户在报告详情页切换不同报告时，需要重新加载配置和笔记数据，完成计算

**刷新机制**：
- 所有计算在前端完成，无需调用后端计算接口
- 刷新时重新获取笔记列表数据，基于最新数据重新计算

## 4. 业务规则

### 4.1 配置验证规则

1. **层级名称验证**：
   - 不能为空
   - 不能与现有层级名称重复（知名KOL除外）
   - 长度限制：1-20个字符

2. **粉丝数范围验证**：
   - 最小值必须大于等于0
   - 如果设置了最大值，最大值必须大于最小值
   - 范围不能与其他层级重叠
   - 所有层级的范围必须连续覆盖（不能留空）

3. **层级数量限制**：
   - 至少保留1个自定义层级
   - 最多支持10个自定义层级（包括知名KOL共11个层级）

### 4.2 统计计算规则

1. **达人去重规则**：
   - 按 `BloggerId` 去重
   - 同一达人在多个层级中出现时，只计入第一个匹配的层级

2. **知名KOL优先级**：
   - 知名KOL层优先级最高
   - 如果达人是官方认证的，无论粉丝数多少，都计入知名KOL层
   - 知名KOL层的达人不会出现在其他自定义层级中

3. **层级匹配规则**：
   - 达人按粉丝数匹配到对应的自定义层级
   - 如果达人的粉丝数在多个层级范围内，计入第一个匹配的层级
   - 如果达人的粉丝数不在任何层级范围内，不计入任何层级（但会计入总计行）

### 4.3 数据更新规则

1. **配置保存规则**：
   - 配置保存后立即生效
   - 配置按报告ID存储，不同报告可以有不同配置
   - 删除配置后，使用系统默认配置

2. **数据刷新规则**：
   - 配置修改后自动刷新统计数据
   - 报告数据更新后自动刷新统计数据
   - 切换报告时自动加载对应配置并刷新统计数据

## 5. 异常处理

### 5.1 数据异常

- **笔记数据缺失**：显示空状态提示
- **达人信息缺失**：跳过该笔记，不影响其他统计
- **配置数据异常**：使用系统默认配置

### 5.2 计算异常

- **除零错误**：占比显示为0%
- **数据溢出**：使用科学计数法或显示"超出范围"
- **计算超时**：显示加载状态，提示用户稍后重试

### 5.3 配置异常

- **配置格式错误**：使用系统默认配置
- **配置验证失败**：显示错误提示，不允许保存
- **保存失败**：显示错误提示，保留当前编辑状态

## 6. 性能要求

### 6.1 响应时间

- 配置加载：< 500ms
- 统计数据计算：< 2s（1000条笔记以内）
- 配置保存：< 1s

### 6.2 数据量支持

- 支持报告内最多10000条笔记
- 支持最多10个自定义层级
- 前端计算性能优化：使用Web Worker或分批处理

## 7. 关联功能

### 7.1 报告功能

- 达人矩阵分析基于报告功能的数据
- 报告数据更新时，达人矩阵分析自动刷新
- 报告删除时，关联的配置也删除

### 7.2 笔记管理功能

- 达人矩阵分析使用笔记的达人信息和互动数据
- 笔记状态变更时，达人矩阵分析自动刷新

## 8. 后续扩展

1. **导出功能**：支持导出达人矩阵统计数据为Excel/CSV
2. **图表展示**：支持将统计数据可视化展示（饼图、柱状图等）
3. **对比分析**：支持对比不同报告的达人矩阵数据
4. **历史记录**：支持查看配置修改历史
5. **模板功能**：支持保存常用配置为模板，快速应用

