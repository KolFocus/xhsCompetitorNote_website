# 数据库测试

## 测试目的

验证数据库表结构、约束、索引、触发器和RLS策略是否正确创建和配置。

## 测试方法

### 1. 执行验证脚本

在 Supabase SQL Editor 中执行：
```sql
-- 执行 .项目文档/03_技术实现/03_数据库设计/验证数据库创建.sql
```

### 2. 手动测试SQL

#### 测试表是否存在
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
  AND table_name IN ('qiangua_blogger', 'qiangua_brand', 'qiangua_note_info');
```

#### 测试主键约束
```sql
-- 应该成功：插入新数据
INSERT INTO qiangua_brand ("Id", "Name", "CreatedAt", "UpdatedAt")
VALUES ('test-001', '测试品牌', NOW(), NOW());

-- 应该失败：插入重复主键
INSERT INTO qiangua_brand ("Id", "Name", "CreatedAt", "UpdatedAt")
VALUES ('test-001', '测试品牌2', NOW(), NOW());
```

#### 测试外键约束
```sql
-- 应该失败：插入不存在的BrandId
INSERT INTO qiangua_note_info ("Id", "BrandId", "CreatedAt", "UpdatedAt")
VALUES ('note-001', '不存在的品牌ID', NOW(), NOW());
```

#### 测试触发器
```sql
-- 插入数据
INSERT INTO qiangua_brand ("Id", "Name", "CreatedAt", "UpdatedAt")
VALUES ('test-002', '测试品牌', NOW(), NOW());

-- 更新数据（UpdatedAt应该自动更新）
UPDATE qiangua_brand 
SET "Name" = '更新后的品牌名' 
WHERE "Id" = 'test-002';

-- 检查UpdatedAt是否已更新
SELECT "Id", "Name", "CreatedAt", "UpdatedAt" 
FROM qiangua_brand 
WHERE "Id" = 'test-002';
```

#### 测试RLS策略
```sql
-- 使用匿名用户测试（应该可以SELECT）
SET ROLE anon;
SELECT COUNT(*) FROM qiangua_note_info;

-- 使用匿名用户测试（应该不能INSERT）
INSERT INTO qiangua_note_info ("Id", "CreatedAt", "UpdatedAt")
VALUES ('test-001', NOW(), NOW());
-- 应该报错：权限不足

-- 恢复角色
RESET ROLE;
```

### 3. 测试索引性能

```sql
-- 测试索引是否生效（使用EXPLAIN）
EXPLAIN ANALYZE
SELECT * FROM qiangua_note_info 
WHERE "BrandId" = '某个品牌ID';

-- 应该看到使用了索引（Index Scan）
```

### 4. 测试数据完整性

```sql
-- 检查是否有孤立数据（外键引用不存在的数据）
SELECT n.* 
FROM qiangua_note_info n
LEFT JOIN qiangua_brand b ON n."BrandId" = b."Id"
WHERE b."Id" IS NULL;

SELECT n.* 
FROM qiangua_note_info n
LEFT JOIN qiangua_blogger bg ON n."BloggerId" = bg."Id"
WHERE bg."Id" IS NULL;
```

## 测试检查清单

- [ ] 所有表都已创建
- [ ] 主键约束正常工作
- [ ] 外键约束正常工作
- [ ] 所有索引都已创建
- [ ] 触发器正常工作（自动更新UpdatedAt）
- [ ] RLS已启用
- [ ] RLS策略正确配置
- [ ] 索引查询性能良好
- [ ] 无孤立数据

## 测试数据清理

测试完成后，清理测试数据：
```sql
-- 删除测试数据
DELETE FROM qiangua_note_info WHERE "Id" LIKE 'test-%';
DELETE FROM qiangua_brand WHERE "Id" LIKE 'test-%';
DELETE FROM qiangua_blogger WHERE "Id" LIKE 'test-%';
```

## 常见问题

### Q: 触发器不工作？
A: 检查触发器函数是否存在，以及触发器是否正确创建

### Q: RLS策略不生效？
A: 确认RLS已启用（ALTER TABLE ... ENABLE ROW LEVEL SECURITY）

### Q: 外键约束报错但数据存在？
A: 检查字段名大小写是否匹配（PostgreSQL区分大小写）

