# 达人矩阵属性分析功能设计文档

## 1. 功能概述

达人矩阵属性分析功能用于对报告中的笔记达人进行分层统计和分析。通过将达人按照粉丝数量和官方认证状态进行分类，展示各层级达人的数量、互动量、笔记数量等关键指标，帮助用户了解报告中达人的分布情况。

**功能位置**：该功能是报告详情页的一个分析板块，位于报告相关笔记列表之上，作为报告分析的重要组成部分。

## 2. 核心功能

### 2.1 达人分层

- **知名KOL层**：固定层级，用于统计官方认证的达人，名称固定为"知名KOL"，不可禁用
- **自定义层级**：支持用户自定义多个层级，每个层级可配置：
  - 层级名称
  - 粉丝数范围（min/max，max可为空表示无上限）
  - 层级之间粉丝数范围严格不重叠

### 2.2 统计展示

展示各层级达人的以下统计指标：
- 达人数量及占比
- 平均粉丝数
- 总互动量（点赞+收藏+评论+分享）及占比
- 笔记数量及占比

### 2.3 数据来源与统计方法

#### 数据来源

达人矩阵统计数据来源于报告关联的笔记数据，具体数据表如下：

1. **笔记数据表（qiangua_note_info）**：
   - 包含报告中的所有笔记记录
   - 每条笔记记录包含达人信息（BloggerId、Fans、OfficialVerified等）
   - 每条笔记记录包含互动数据（LikedCount、CollectedCount、CommentsCount、ShareCount）

2. **达人数据表（qiangua_blogger）**：
   - 存储达人的详细信息
   - 包含粉丝数（Fans）和官方认证状态（OfficialVerified）等字段
   - 作为达人信息的权威数据源（当笔记表中的达人信息需要更新时，可关联查询）

3. **报告笔记关联表（qiangua_report_note_rel）**：
   - 记录报告与笔记的关联关系
   - 用于确定哪些笔记属于当前报告

#### 统计方法

统计过程基于报告关联的所有笔记数据，按以下步骤进行：

1. **数据筛选**：
   - 从 `qiangua_report_note_rel` 表中获取当前报告的所有笔记ID
   - 关联 `qiangua_note_info` 表获取笔记详细信息和达人信息
   - 仅统计状态为"active"的笔记记录

2. **达人分层**：
   - **知名KOL层**：筛选 `OfficialVerified = true` 的达人（基于笔记表中的 `OfficialVerified` 字段）
   - **自定义层级**：根据配置的粉丝数范围，筛选 `Fans` 字段在指定范围内的达人（基于笔记表中的 `Fans` 字段）
   - 注意：同一达人可能出现在多个笔记中，统计时需要对达人进行去重处理

3. **指标计算**：
   - **达人数量**：统计该层级中不重复的达人数量（按 `BloggerId` 去重）
   - **达人占比**：该层级达人数量 / 所有层级达人总数 × 100%
   - **平均粉丝数**：该层级所有达人的粉丝数总和 / 该层级达人数量（使用笔记表中的 `Fans` 字段，按达人去重后计算平均值）
   - **总互动量**：该层级所有笔记的互动量总和 = 该层级所有笔记的（LikedCount + CollectedCount + CommentsCount + ShareCount）之和
   - **互动量占比**：该层级总互动量 / 所有层级总互动量 × 100%
   - **笔记数量**：该层级达人的笔记总数（不去重，统计所有笔记记录）
   - **笔记占比**：该层级笔记数量 / 所有层级笔记总数 × 100%

4. **总计行统计**：
   - 总计行统计的是报告中的所有有效笔记（状态为"active"的笔记），而不是表格中各层级数据的简单相加
   - 原因：粉丝数过少的达人可能不在任何自定义层级范围内，且不是知名KOL，这些达人的笔记不会出现在表格的任何层级中
   - **总计行指标计算**：
     - **层级名称**：显示"总计"
     - **粉丝数范围**：显示报告所有有效笔记对应的不重复达人中，粉丝数的最小值和最大值，格式：`最小值 - 最大值`（例如：`0.5万 - 120万`）
     - **达人数量**：报告所有有效笔记对应的不重复达人总数（按 `BloggerId` 去重）
     - **达人占比**：100.0%
     - **平均粉丝数**：报告所有有效笔记对应的不重复达人的平均粉丝数（按达人去重后计算平均值）
     - **总互动量**：报告所有有效笔记的互动量总和（所有active笔记的互动量之和）
     - **互动量占比**：100.0%
     - **笔记数量**：报告所有有效笔记的总数（所有active笔记的数量）
     - **笔记占比**：100.0%

5. **数据去重说明**：
   - 达人数量统计时，需要按 `BloggerId` 去重，确保每个达人只计算一次
   - 平均粉丝数计算时，需要先按达人去重，再计算平均值（避免同一达人的多条笔记影响平均值）
   - 笔记数量和互动量统计时，不去重，统计所有笔记记录（因为同一达人的多条笔记都应计入）

### 2.4 配置管理

- 支持查看和修改达人矩阵配置
- 支持添加、删除、编辑自定义层级
- 配置验证：确保层级名称唯一、范围不重叠、范围连续无留空、数值合理
- 支持重置为默认配置
- **配置加载逻辑**：
  - 系统默认配置：写在代码中，包含知名KOL层和默认的自定义层级（如：头部达人、腰部达人、初级达人、新手达人）
  - 用户自定义配置：存储在数据库中，按报告ID关联
  - 加载优先级：如果存在用户自定义配置，则使用自定义配置；如果不存在，则使用系统默认配置

### 2.5 接口设计与计算方式

#### 接口设计

1. **获取达人分层配置接口**：
   - 接口返回当前报告的达人分层配置
   - 如果数据库中不存在该报告的配置，返回null或空，前端使用系统默认配置
   - 配置包含：知名KOL层（固定）和自定义层级列表

2. **获取笔记列表接口**：
   - 接口返回当前报告的所有有效笔记（状态为"active"）
   - 笔记数据包含：笔记ID、达人ID、达人粉丝数、达人官方认证状态、互动数据等
   - 前端基于这些数据进行统计计算

#### 计算方式

- **前端计算**：所有统计数据在前端完成计算，不依赖后端计算接口
- **计算时机**：页面加载时、配置修改后、报告数据更新后
- **计算逻辑**：按照"2.3 数据来源与统计方法"中定义的统计方法进行

### 2.6 表格展示结构

#### 表格列定义

| 列名 | 宽度 | 对齐 | 说明 | 示例数据 |
|------|------|------|------|----------|
| **层级名称** | 150px | 左对齐 | 显示层级名称，知名KOL有特殊标识 | "知名KOL" / "头部达人" |
| **粉丝数范围** | 150px | 左对齐 | 自定义层级显示配置的范围，格式：`≥50万` 或 `10万-50万`；知名KOL和总计行显示实际范围，格式：`最小值 - 最大值` | "≥50万" / "10万-50万" / "0.5万 - 120万" |
| **达人数量** | 120px | 右对齐 | 该层级的达人总数 | 15 |
| **达人占比** | 100px | 右对齐 | 占所有达人的百分比，带%符号 | 12.5% |
| **平均粉丝数** | 120px | 右对齐 | 该层级达人的平均粉丝数，格式化显示 | 85.2万 |
| **总互动量** | 120px | 右对齐 | 该层级所有笔记的互动量总和（点赞+收藏+评论+分享），格式化显示 | 125.6万 |
| **互动量占比** | 100px | 右对齐 | 占所有互动量的百分比 | 35.8% |
| **笔记数量** | 120px | 右对齐 | 该层级达人的笔记总数 | 234 |
| **笔记占比** | 100px | 右对齐 | 占所有笔记的百分比 | 18.2% |

#### 表格数据示例（以默认配置为例）

假设默认配置为：
- **知名KOL**：官方认证达人
- **头部达人**：粉丝数 ≥ 50万
- **腰部达人**：粉丝数 10万 - 50万
- **初级达人**：粉丝数 1万 - 10万
- **新手达人**：粉丝数 < 1万

表格展示效果：

```
┌──────────────┬──────────────┬──────────┬──────────┬──────────────┬──────────────┬──────────────┬──────────┬──────────┐
│ 层级名称     │ 粉丝数范围   │ 达人数量 │ 达人占比 │ 平均粉丝数   │ 总互动量     │ 互动量占比   │ 笔记数量 │ 笔记占比 │
├──────────────┼──────────────┼──────────┼──────────┼──────────────┼──────────────┼──────────────┼──────────┼──────────┤
│ 知名KOL      │ -            │ 15       │ 12.5%    │ 85.2万       │ 125.6万      │ 35.8%        │ 234      │ 18.2%    │
│ 头部达人     │ ≥50万        │ 28       │ 23.3%    │ 78.5万       │ 156.3万      │ 44.6%        │ 312      │ 24.3%    │
│ 腰部达人     │ 10万-50万    │ 42       │ 35.0%    │ 28.6万       │ 58.2万       │ 16.6%        │ 456      │ 35.5%    │
│ 初级达人     │ 1万-10万     │ 25       │ 20.8%    │ 5.2万        │ 8.5万        │ 2.4%         │ 198      │ 15.4%    │
│ 新手达人     │ <1万         │ 10       │ 8.3%     │ 0.8万        │ 1.4万        │ 0.4%         │ 87       │ 6.8%     │
├──────────────┼──────────────┼──────────┼──────────┼──────────────┼──────────────┼──────────────┼──────────┼──────────┤
│ 总计         │ 0.5万-120万  │ 120      │ 100.0%   │ 35.8万       │ 350.0万      │ 100.0%       │ 1287     │ 100.0%   │
└──────────────┴──────────────┴──────────┴──────────┴──────────────┴──────────────┴──────────────┴──────────┴──────────┘
```

**注意**：总计行的数据统计的是报告中的所有有效笔记，而不是表格中各层级数据的简单相加。因为可能存在粉丝数不在任何层级范围内的达人，这些达人的笔记不会出现在表格的任何层级中。

#### 设计要点

1. **知名KOL行**：
   - "粉丝数范围"列显示 "-" 或留空
   - 可用特殊样式（如背景色或图标）标识

2. **数字格式化**：
   - 粉丝数、互动量：≥1万显示为"X.X万"，<1万显示原数字
   - 占比：保留1位小数，带%符号

3. **对齐方式**：
   - 文字列左对齐
   - 数字列右对齐

4. **总计行**：
   - 总计行显示在表格底部，用分隔线与各层级数据区分
   - 总计行统计的是报告中的所有有效笔记，而不是表格中各层级数据的简单相加
   - 总计行的"粉丝数范围"显示报告所有有效笔记对应的不重复达人中，粉丝数的最小值和最大值
   - 总计行的所有占比列均显示100.0%
   - 总计行可用特殊样式（如加粗、背景色）标识

5. **可选功能**：
   - 支持按任意数字列排序

## 3. 流程细化

### 3.1 查看达人矩阵分析

1. 用户进入报告详情页
2. 在报告详情页顶部（笔记列表之上）查看"达人矩阵属性分析"板块
3. 系统调用接口获取：
   - 达人分层配置（如果不存在则使用系统默认配置）
   - 报告关联的所有有效笔记数据
4. 前端根据当前配置的层级规则，对达人进行分层统计计算
5. 展示各层级统计数据表格

### 3.2 配置层级

1. 用户点击"配置"按钮，打开配置弹窗
2. 系统加载配置：
   - 如果存在该报告的自定义配置，则加载自定义配置
   - 如果不存在，则加载系统默认配置（写在代码中）
3. 查看当前层级配置（知名KOL固定显示，不可编辑）
4. 对自定义层级进行以下操作：
   - **添加层级**：点击"添加层级"，输入层级名称和粉丝数范围
   - **编辑层级**：点击层级行的编辑按钮，修改层级名称或范围
   - **删除层级**：点击层级行的删除按钮（至少保留一个自定义层级）
5. 系统验证配置：
   - 层级名称不能为空且不能重复
   - 粉丝数范围不能重叠
   - 层级之间不能留空（所有粉丝数范围需连续覆盖）
   - 数值必须合理（min < max，或max为空）
6. 点击"保存"应用配置（保存到数据库），或点击"重置"恢复系统默认配置
7. 配置保存后，前端自动重新计算并刷新统计数据

### 3.3 数据刷新

统计数据在以下场景下需要重新计算：

1. **页面加载时**：
   - 用户进入报告详情页时，自动加载配置和笔记数据，完成计算

2. **配置修改后**：
   - 用户保存自定义配置后，前端自动重新计算统计数据

3. **报告数据更新后**（参考创建报告功能设计文档）：
   - **追加笔记**：用户通过"追加笔记"功能添加新笔记到报告后，需要重新计算
   - **忽略笔记**：用户将笔记标记为忽略状态后，有效笔记数量减少，需要重新计算
   - **删除笔记**：用户从报告中删除笔记后，有效笔记数量减少，需要重新计算
   - **恢复笔记**：用户恢复被忽略或删除的笔记后，有效笔记数量增加，需要重新计算

4. **切换报告时**：
   - 用户在报告详情页切换不同报告时，需要重新加载配置和笔记数据，完成计算

**刷新机制**：
- 所有计算在前端完成，无需调用后端计算接口
- 刷新时重新获取笔记列表数据，基于最新数据重新计算

## 4. 交互UI设计方案

### 4.1 整体布局

**位置**：报告详情页顶部，位于报告相关笔记列表之上

**布局结构**：
```
┌─────────────────────────────────────────────────────────┐
│  达人矩阵属性分析                                        │
│  ┌───────────────────────────────────────────────────┐  │
│  │  [配置] 按钮（右上角）                             │  │
│  │                                                    │  │
│  │  ┌─────────────────────────────────────────────┐  │  │
│  │  │  统计表格（见4.2）                          │  │  │
│  │  └─────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

**组件说明**：
- 标题区域：显示"达人矩阵属性分析"标题
- 操作按钮：右上角显示"配置"按钮
- 表格区域：展示统计数据表格

### 4.2 统计表格UI

**表格样式**：
- 使用标准表格组件，支持横向滚动（当列数较多时）
- 表头固定，支持排序（可选功能）
- 行高适中，确保数据可读性

**视觉设计**：
- **知名KOL行**：
  - 背景色：浅蓝色或浅金色（与其他行区分）
  - 可选：在层级名称前添加图标标识（如：⭐）
  
- **总计行**：
  - 背景色：浅灰色
  - 字体加粗
  - 用分隔线与上方数据区分

- **数字格式化**：
  - 粉丝数、互动量：≥1万显示为"X.X万"，<1万显示原数字（如：0.8万）
  - 占比：保留1位小数，带%符号（如：12.5%）

- **对齐方式**：
  - 文字列（层级名称、粉丝数范围）：左对齐
  - 数字列（达人数量、占比、平均粉丝数等）：右对齐

**交互功能**：
- 鼠标悬停：行高亮显示
- 点击表头：按该列排序（可选功能）

### 4.3 配置弹窗UI

**弹窗布局**：
```
┌─────────────────────────────────────────────┐
│  达人矩阵配置                    [×] 关闭   │
├─────────────────────────────────────────────┤
│                                             │
│  知名KOL（固定，不可编辑）                  │
│  ┌───────────────────────────────────────┐  │
│  │ 层级名称：知名KOL          [不可编辑] │  │
│  │ 粉丝数范围：-              [不可编辑] │  │
│  └───────────────────────────────────────┘  │
│                                             │
│  自定义层级                                 │
│  ┌───────────────────────────────────────┐  │
│  │ 层级名称：[头部达人      ]  [编辑][删除]│  │
│  │ 粉丝数范围：[≥50万       ]            │  │
│  └───────────────────────────────────────┘  │
│  ┌───────────────────────────────────────┐  │
│  │ 层级名称：[腰部达人      ]  [编辑][删除]│  │
│  │ 粉丝数范围：[10万-50万   ]            │  │
│  └───────────────────────────────────────┘  │
│                                             │
│  [+ 添加层级]                               │
│                                             │
│  ┌──────────┐  ┌──────────┐               │
│  │   保存   │  │   重置   │               │
│  └──────────┘  └──────────┘               │
└─────────────────────────────────────────────┘
```

**配置项说明**：

1. **知名KOL层**：
   - 固定显示，不可编辑
   - 层级名称和粉丝数范围字段置灰或显示"不可编辑"标识

2. **自定义层级列表**：
   - 每个层级显示为一个卡片或行
   - 显示层级名称和粉丝数范围
   - 提供"编辑"和"删除"按钮
   - 至少保留一个自定义层级（删除按钮在只剩一个层级时禁用）

3. **添加层级**：
   - 点击"+ 添加层级"按钮，在列表末尾添加新的空层级行
   - 新层级行进入编辑状态，可直接输入

4. **编辑层级**：
   - 点击"编辑"按钮，该层级行进入编辑状态
   - 编辑状态：层级名称和粉丝数范围变为输入框
   - 粉丝数范围输入：
     - 支持两种格式：`≥X万`（无上限）或 `X万-Y万`（有范围）
     - 提供输入提示和格式说明
   - 编辑完成后点击"保存"或按回车确认

5. **删除层级**：
   - 点击"删除"按钮，弹出确认提示："确定要删除该层级吗？"
   - 确认后删除，至少保留一个自定义层级

6. **操作按钮**：
   - **保存**：保存当前配置到数据库，关闭弹窗，刷新统计数据
   - **重置**：恢复为系统默认配置，不保存，仅更新弹窗显示
   - **关闭**：关闭弹窗，不保存修改

**验证提示**：
- 层级名称为空：提示"层级名称不能为空"
- 层级名称重复：提示"层级名称已存在，请使用其他名称"
- 粉丝数范围重叠：提示"粉丝数范围与其他层级重叠，请调整"
- 层级范围留空：提示"层级之间不能留空，请确保所有粉丝数范围连续覆盖"
- 粉丝数范围格式错误：提示"请输入正确的格式，如：≥50万 或 10万-50万"
- 数值不合理（min ≥ max）：提示"最小值必须小于最大值"

### 4.4 加载状态

**数据加载时**：
- 表格区域显示加载动画（如：骨架屏或loading spinner）
- 配置按钮禁用

**数据为空时**：
- 显示空状态提示："暂无数据"或"该报告暂无有效笔记"
