---
标题: 笔记内容标签化功能规格
Owner: 产品（TBD）
状态: 待批准
Canonical: true
Links:
  业务规则: ./笔记标签化业务逻辑.md
  UI规格: ../../02_UI设计/02_原型与线框图/笔记标签化页面设计.md
  API规格: ../../03_技术实现/05_API接口契约/API_笔记标签化接口.md
  测试用例: ../../04_质量保证/02_测试用例/笔记标签化功能测试用例.md
---

# 笔记内容标签化功能规格

> 口径以"业务规则"文档为准，本文仅描述范围、用户诉求与验收标准。

## 1. 功能概述

笔记内容标签化功能用于为笔记系统引入一个强大且灵活的标签体系。它允许数据分析师从不同维度对笔记进行分类和场景化标记，从而极大地提升内容分析效率。

**功能位置**：
- **标签管理页面**：位于 `/dashboard/tags`，用于管理标签系列和标签
- **笔记打标页面**：位于 `/dashboard/notes/tagging`，专门的笔记打标页面，支持单篇和批量打标操作

**功能作用**：
- 提供多维度的笔记分类能力，支持系统预设和用户自定义标签系列
- 支持单篇和批量笔记打标操作

## 2. 核心功能

### 2.1 标签体系管理

#### 2.1.1 标签系列类型

- **系统标签系列**：由系统预设，对所有用户可见。标签系列和其中的标签由管理员统一维护，用户不可编辑或删除。保证平台核心分类标准的一致性。
- **用户自定义标签系列**：由用户为满足个人或特定项目需求而创建。用户对其拥有完全的管理权限（创建、重命名、删除）。

#### 2.1.2 标签系列管理

- **查看标签体系**：在标签管理页面查看所有可用的标签系列，清晰区分"系统标签系列"和"我创建的标签系列"；每个标签系列以单行展示，系列名称后串接该系列下所有标签（以逗号分隔），行尾提供操作区（系统系列操作区置灰，用户系列提供`编辑`按钮）
- **创建自定义标签系列**：输入系列名称创建新的标签系列，创建时可选择同时创建初始标签，也允许创建空标签系列
- **编辑与删除自定义标签系列**：支持重命名自定义标签系列；删除标签系列时会级联删除其下的所有标签，并自动解除这些标签与所有笔记的关联，操作前需二次确认
- **管理标签**：在用户自定义的标签系列下，支持添加新标签、重命名已有标签、删除标签；系统标签系列下的标签不可被用户编辑或删除

### 2.2 笔记打标操作

笔记打标操作仅在笔记打标页面（`/dashboard/notes/tagging`）进行，该页面是专门的笔记打标工作台，提供完整的打标功能。

#### 2.2.1 笔记打标页面功能

- **页面布局**：页面包含两个筛选区域、笔记列表区域、批量操作工具栏
- **笔记展示**：以表格列表形式展示笔记，字段与`全部笔记 -> 笔记列表`保持一致
- **筛选功能**：
  - 置顶筛选区：仅包含"标签系列"选择器（必选）。未选择标签系列时，不展示笔记列表并提示选择标签系列
  - 二级筛选区：与笔记列表一致的常规筛选项（品牌、博主、日期范围等），并新增"我的报告"选择器、"标签：未打标"开关（默认开启），以及所选标签系列下的标签列表（用于辅助定位未打标或特定标签的笔记）
- **标签展示**：每篇笔记下方清晰展示已打上的标签，支持快速查看和移除
- **标签编辑列**：表格右侧固定一列展示标签下拉框
  - 默认值为该笔记在当前标签系列下已保存的标签集合；若未保存过则为空
  - 用户可在下拉框中调整标签选择或清空当前笔记的标签，保存后即时更新

#### 2.2.2 单篇笔记打标

- **打标入口**：在笔记列表右侧固定的标签编辑列中，点击标签下拉选择器
- **标签选择器**：基于 Ant Design `Select` 组件，展示当前所选标签系列下的全部标签，支持搜索
- **打标操作**：在下拉框中选择或移除标签项，失焦时自动保存并出现加载状态，保存完成后下拉框选项即时更新
- **清空能力**：点击下拉框右侧的清空图标即可移除当前系列下的全部已选标签
- **实时反馈**：保存过程通过下拉框内的 loading 状态提示，保存完成后筛选结果与展示同步更新

#### 2.2.3 批量笔记打标

- **批量选择**：在笔记打标页面，通过复选框选择多篇笔记，支持全选、反选、按条件选择
- **批量操作工具栏**：位于表格右上角，包含"批量打标"与"批量清除"按钮；未选择笔记时按钮置灰不可用，勾选笔记后自动变为可点击状态
- **批量打标**：点击"批量打标"按钮，弹出标签选择器，选择要应用的标签，确认后为所有选中的笔记批量添加这些标签
- **批量清除**：点击"批量清除"按钮，直接删除选中笔记与当前标签系列下所有标签的关联关系（物理删除），操作前弹出二次确认
- **操作反馈**：批量操作完成后显示操作结果提示（成功数量、失败数量及失败原因）

#### 2.2.4 笔记打标页面筛选

- **筛选区划分**：
  - 置顶筛选区（第一行）：仅包含"标签系列"选择器（必选）。未选择时，不展示笔记列表与批量工具栏，显示空表格及提示"请先选择标签系列"
  - 二级筛选区（第二行）：包含与笔记列表一致的筛选项（品牌、博主、日期范围等）+
    - "我的报告"选择器：可限定为某个报告范围内的笔记
    - 标签筛选下拉：包含"未打标"选项与当前标签系列下的标签列表，二者位于同一个下拉框内；默认"未打标"，单选（与其他筛选条件组合），也可不选。
- **筛选逻辑**：
  - 默认选中"未打标"，返回当前所选标签系列下未被打任一标签的笔记
  - 若选择具体标签，则展示至少包含该标签的笔记（限定在当前所选标签系列）
  - 清空选择时，标签筛选不生效，可配合其他筛选条件单独使用
- **筛选结果**：筛选结果实时更新笔记列表；筛选条件在筛选区内展示，支持清除单个或全部条件

## 3. 功能流程

### 3.1 标签体系管理流程

#### 3.1.1 查看标签体系

1. 用户进入标签管理页面（`/dashboard/tags`）
2. 系统加载所有标签系列（系统标签系列 + 用户自定义标签系列）
3. 页面展示标签系列列表，清晰区分系统标签系列和用户自定义标签系列
4. 列表中每个标签系列占据单行：系列名称后以逗号串联展示该系列下的所有标签，行尾显示操作区（系统系列操作区置灰，用户系列提供`编辑`按钮）
5. 系统标签系列显示"系统"标识，且管理操作按钮置灰或隐藏

#### 3.1.2 创建自定义标签系列

1. 用户点击"新建标签系列"按钮
2. 弹出创建标签系列对话框
3. 用户输入系列名称（必填，例如"2025双十一项目"，需满足4~20个字符，中文按字数计算）
4. 用户创建至少一个标签（必填，可继续新增多个标签）
5. 用户为每个标签填写名称（需满足4~20个字符，中文按字数计算）
6. 用户点击"确认"创建标签系列
7. 系统验证：系列名称与标签名称均需满足4~20个字符长度限制（中文按字数计算）、不可为空、不可重复
8. 创建成功后，标签系列出现在"我创建的标签系列"列表中

#### 3.1.3 编辑自定义标签系列

1. 用户在"我创建的标签系列"列表中找到目标标签系列
2. 点击操作列中的`编辑`按钮
3. 弹出标签系列编辑弹窗，顶部展示标签系列名称，正文展示该系列下的所有标签
4. 用户将鼠标悬停在系列名称上，触发右侧的编辑 icon，点击进入就地编辑模式，更新系列名称
5. 失焦或按 Enter 后自动保存，系统校验名称（不能为空、不能重复，长度需在4~20个字符之间，中文按字数计算）
6. 保存成功时页面顶部出现成功提示，弹窗保持打开状态

#### 3.1.4 删除自定义标签系列

1. 用户在"标签系列"列表中，操作区点击"删除"
2. 弹出二次确认对话框，提示：
   - 删除该标签系列将级联删除其下的所有标签
   - 将自动解除这些标签与所有笔记的关联
   - 此操作不可恢复
3. 用户确认删除
4. 系统执行删除操作：
   - 删除标签系列记录
   - 级联删除该系列下的所有标签记录
   - 删除所有笔记与这些标签的关联关系
5. 删除成功后，标签系列从列表中移除

#### 3.1.5 管理标签（在自定义标签系列下）

1. **添加标签**：
   - 在标签系列编辑弹窗中，点击标签列表底部的"添加标签"按钮
   - 新增标签行立即进入就地编辑模式，输入标签名称（必填，不能为空、不能重复，长度需在4~20个字符之间，中文按字数计算）
   - 失焦或按 Enter 后自动保存，新增标签即时出现在列表中

2. **重命名标签**：
   - 将鼠标悬停在目标标签上，显示标签名称右侧的编辑 icon
   - 点击 icon 进入就地编辑模式，更新标签名称
   - 失焦或按 Enter 后自动保存，系统完成校验后更新标签

3. **删除标签**：
   - 在标签系列编辑弹窗的标签行中点击"删除"按钮
   - 弹出确认对话框，提示将解除该标签与所有笔记的关联
   - 确认后删除标签，并删除所有笔记与该标签的关联关系

### 3.2 笔记打标流程

#### 3.2.1 进入笔记打标页面

1. 用户通过导航菜单或链接进入笔记打标页面（`/dashboard/notes/tagging`）
2. 页面初始化：展示空表格状态，提示"请先选择标签系列"，笔记列表与批量工具栏暂不展示
3. 在置顶筛选区选择目标标签系列后，系统加载该系列下的全部标签
4. 加载完成即展示笔记列表，每行包含标题、内容预览、已打标签、标签编辑列等信息
5. 二级筛选区的标签下拉框默认选中"未打标"选项，可结合常规筛选项与"我的报告"筛选笔记

#### 3.2.2 单篇笔记打标

1. 在笔记列表右侧的标签编辑列找到目标笔记的标签选择器
2. 点击选择器展开下拉框，展示当前标签系列下的全部标签及搜索框（已保存的标签默认勾选）
3. 勾选或取消勾选标签项，实时调整待保存的标签集合
4. 失焦或按 Enter 后自动保存，选择器展示 loading 状态并完成校验
5. 保存成功后，下拉框自动收起并即时刷新该笔记展示的标签，可通过标签上的"×"快速移除单个标签

#### 3.2.3 批量笔记打标

1. 通过表格左侧复选框选择多篇笔记（支持单选、多选、全选当前页）
2. 选中后，表格右上出现批量操作工具栏，实时显示已勾选的笔记数量
3. 点击"批量打标"按钮，弹出标签选择器（同单篇笔记打标）
4. 勾选要应用的标签，点击"确认"按钮
5. 系统为所有选中的笔记批量添加所选标签，并显示操作结果（成功数、失败数及原因）
6. 操作完成后，笔记列表与标签展示即时刷新

#### 3.2.4 批量清除

1. 通过复选框选择需要清除标签的笔记
2. 点击批量操作工具栏中的"批量清除"按钮
3. 弹出二次确认对话框，说明将删除选中笔记在当前标签系列下的全部标签关联且不可撤销
4. 用户确认执行，系统批量清除关联关系并返回成功/失败明细
5. 清除完成后，笔记列表即时更新，相关标签全部移除

#### 3.2.5 在笔记打标页面筛选笔记

1. 在置顶筛选区选择"标签系列"（必选）。未选择时，展示空状态提示"请先选择标签系列"
2. 选择标签系列后，二级筛选区生效，可使用品牌、博主、日期范围等常规筛选项
3. 二级筛选区的标签下拉框默认处于"未打标"选项，返回当前系列下未打任一标签的笔记
4. 可结合"我的报告"筛选范围；如需按标签筛选，先取消"标签：未打标"后从标签列表中单选目标标签
5. 筛选条件应用后即时刷新笔记列表，条件条展示在筛选区域，可清除单个或全部条件
6. 表格右侧的标签编辑列始终与筛选结果同步，支持直接调整并即时保存标签

## 4. 业务规则

### 4.1 验证规则

#### 4.1.1 标签系列名称验证

1. **必填验证**：标签系列名称不能为空
2. **长度限制**：4~20个字符（中文按字数计算）
3. **唯一性验证**：同一用户下，标签系列名称不能重复（系统标签系列不计入）
4. **字符类型**：支持中文、英文、数字、常用符号

#### 4.1.2 标签名称验证

1. **必填验证**：标签名称不能为空
2. **长度限制**：4~20个字符（中文按字数计算）
3. **唯一性验证**：同一标签系列下，标签名称不能重复
4. **字符类型**：支持中文、英文、数字、常用符号


### 4.2 计算规则

#### 4.2.1 标签筛选计算规则

1. **标签列表单选（当前标签系列内）**：
   - 选择单个标签时，展示至少包含该标签的笔记（仅限于当前所选标签系列）

2. **未打标筛选（当前标签系列内）**：
   - 默认开启，返回在当前所选标签系列下未打任何标签的笔记
   - 与标签列表单选互斥；如同时选择，优先"未打标"

3. **筛选范围与组合**：
   - 仅筛选当前用户有权限查看的笔记
   - 可与品牌、博主、日期范围、我的报告等条件组合

### 4.3 数据更新规则

所有标签系列、标签及笔记打标的增删改操作需在 Supabase 中记录触发该操作的用户 Supabase UID 与操作时间，用于审计与追踪。

#### 4.3.1 标签系列创建规则

1. **创建时机**：用户点击"确认"后立即创建
2. **数据存储**：标签系列记录包含：系列ID、系列名称、创建者 Supabase UID、创建时间、是否系统标签系列
3. **权限控制**：只有创建者可以编辑和删除自己创建的标签系列

#### 4.3.2 标签系列删除规则

1. **级联删除**：
   - 删除标签系列时，自动删除该系列下的所有标签
   - 自动删除所有笔记与这些标签的关联关系

2. **数据一致性**：
   - 使用事务确保删除操作的原子性
   - 删除失败时回滚所有操作

3. **操作审计**：记录执行删除操作的 Supabase UID 与操作时间
4. **影响范围**：
   - 仅影响当前用户创建的标签系列
   - 系统标签系列不可删除

#### 4.3.3 标签创建规则

1. **创建时机**：用户点击"确认"后立即创建
2. **数据存储**：标签记录包含：标签ID、标签名称、所属标签系列ID、创建者 Supabase UID、创建时间、最近操作 Supabase UID、最近操作时间
3. **权限控制**：
   - 用户自定义标签系列下的标签：创建者可以编辑和删除
   - 系统标签系列下的标签：用户不可编辑和删除

#### 4.3.4 标签删除规则

1. **关联清理**：删除标签时，自动删除所有笔记与该标签的关联关系
2. **数据一致性**：使用事务确保删除操作的原子性，并记录执行删除的 Supabase UID 与操作时间

#### 4.3.5 笔记打标规则

1. **关联创建**：
   - 为笔记打标时，创建笔记与标签的多对多关联记录
   - 如果关联已存在，跳过（避免重复）

2. **关联删除**：
   - 移除笔记标签时，删除对应的关联记录
   - 如果关联不存在，跳过（幂等操作）

3. **操作审计**：记录每次单笔或批量打标/清除操作的 Supabase UID 与操作时间
4. **批量操作**：
   - 批量打标时，为每篇笔记创建关联记录
   - 使用批量插入优化性能
   - 部分失败时，返回成功和失败的数量

## 5. 异常处理

### 5.1 数据异常

#### 5.1.1 标签系列数据异常

- **标签系列不存在**：提示"标签系列不存在"，返回标签管理页面
- **标签系列已被删除**：提示"标签系列已被删除"，刷新列表
- **标签系列数据损坏**：使用系统默认配置，记录错误日志

#### 5.1.2 标签数据异常

- **标签不存在**：提示"标签不存在"，刷新标签列表
- **标签已被删除**：自动从笔记的标签列表中移除该标签，提示用户
- **标签数据损坏**：跳过该标签，记录错误日志

#### 5.1.3 笔记数据异常

- **笔记不存在**：提示"笔记不存在"，从列表中移除
- **笔记已被删除**：自动清理该笔记的所有标签关联，提示用户
- **笔记数据损坏**：跳过该笔记，记录错误日志

### 5.2 计算异常

#### 5.2.1 筛选计算异常

- **筛选条件无效**：提示"筛选条件无效，请重新选择"，清除无效筛选条件
- **筛选结果为空**：显示"未找到符合条件的笔记"空状态提示
- **筛选超时**：显示加载状态，提示"数据量较大，请稍候"，超过10秒后提示"筛选超时，请减少筛选条件或联系管理员"

### 5.3 配置异常

#### 5.3.1 标签系列配置异常

- **配置格式错误**：使用系统默认配置，记录错误日志
- **配置验证失败**：显示错误提示，不允许保存，保留当前编辑状态
- **保存失败**：显示错误提示（网络错误、权限不足等），保留当前编辑状态，允许重试

#### 5.3.2 标签配置异常

- **标签名称重复**：提示"该标签系列下已存在同名标签"，不允许保存
- **保存失败**：显示错误提示，保留当前编辑状态

### 5.4 操作异常

#### 5.4.1 打标操作异常

- **笔记不存在**：提示"笔记不存在，无法打标"，刷新列表
- **标签不存在**：提示"标签不存在"，从选择器中移除该标签
- **批量操作部分失败**：显示成功和失败的数量，列出失败原因
- **网络错误**：提示"网络错误，请检查网络连接后重试"，允许重试

## 标签系列的数据结构

- 标签系列表（`qiangua_tag_set`）：`TagSetId`, `TagSetName`, `type`（`system`/`custom`）, `UserId`, `CreatedAt`, `UpdatedAt`
- 标签表（`qiangua_tag`）：`TagId`, `TagSetId`, `TagName`, `UserId`, `CreatedAt`, `UpdatedAt`
- 笔记标签关联表（`qiangua_note_tag`）：`NoteId`, `TagId`, `UserId`, `CreatedAt`, `UpdatedAt`

## 初始化数据

- 系统标签系列"内容场景"：通过手动初始化脚本创建
- 初始标签：`品牌品宣`、`明星代言`、`穿搭叙事`、`明星同款私服`、`创意手绘视频`、`创意舞蹈视频`；在创建"内容场景"标签系列时自动创建

### 3. 数据库设计部分
- [x] 完整的创建表 SQL 脚本（参考 `报告功能创建表SQL.sql`）
- [x] RLS（行级安全）策略（用户权限控制）
- [x] 触发器函数（自动更新 `UpdatedAt`）
- [x] 表关系说明（表之间的关联关系）
- [x] 查询优化建议（常用查询 SQL 示例）

#### 3.1 创建表 SQL 脚本

```sql
-- public schema assumptions align with Supabase defaults
create extension if not exists "pgcrypto";

create or replace function public.set_updated_at()
returns trigger as $$
begin
  new."UpdatedAt" := now();
  return new;
end;
$$ language plpgsql;

create or replace function public.normalize_tag_set_name()
returns trigger as $$
begin
  new."TagSetName" := nullif(btrim(new."TagSetName"), '');
  return new;
end;
$$ language plpgsql;

create or replace function public.normalize_tag_name()
returns trigger as $$
begin
  new."TagName" := nullif(btrim(new."TagName"), '');
  return new;
end;
$$ language plpgsql;

create table public.qiangua_tag_set (
  "TagSetId" uuid not null default gen_random_uuid(),
  "TagSetName" text not null,
  "Description" text null,
  type text not null default 'custom'::text,
  "UserId" uuid null,
  "CreatedAt" timestamp with time zone not null default now(),
  "UpdatedAt" timestamp with time zone not null default now(),
  constraint qiangua_tag_set_pkey primary key ("TagSetId"),
  constraint chk_tag_set_name_length check (
    char_length(btrim("TagSetName")) >= 4
    and char_length(btrim("TagSetName")) <= 20
  ),
  constraint chk_tag_set_owner_scope check (
    (type = 'system'::text and "UserId" is null)
    or (type = 'custom'::text and "UserId" is not null)
  ),
  constraint chk_tag_set_type check (
    type = any (array['system'::text, 'custom'::text])
  )
);

create table public.qiangua_tag (
  "TagId" uuid not null default gen_random_uuid(),
  "TagSetId" uuid not null,
  "TagName" text not null,
  "UserId" uuid null,
  "CreatedAt" timestamp with time zone not null default now(),
  "UpdatedAt" timestamp with time zone not null default now(),
  constraint qiangua_tag_pkey primary key ("TagId"),
  constraint qiangua_tag_TagSetId_fkey foreign key ("TagSetId") references public.qiangua_tag_set ("TagSetId") on delete cascade,
  constraint chk_tag_name_length check (
    char_length(btrim("TagName")) >= 4
    and char_length(btrim("TagName")) <= 20
  )
);

create table public.qiangua_note_tag (
  "NoteId" character varying not null,
  "TagId" uuid not null,
  "UserId" uuid not null,
  "CreatedAt" timestamp with time zone not null default now(),
  "UpdatedAt" timestamp with time zone not null default now(),
  constraint pk_qiangua_note_tag primary key ("NoteId", "TagId"),
  constraint qiangua_note_tag_NoteId_fkey foreign key ("NoteId") references public.qiangua_note_info ("NoteId") on delete cascade,
  constraint qiangua_note_tag_TagId_fkey foreign key ("TagId") references public.qiangua_tag ("TagId") on delete cascade
);

create unique index if not exists uq_tag_set_system_name
  on public.qiangua_tag_set using btree (lower("TagSetName"))
  where type = 'system'::text
  tablespace pg_default;

create unique index if not exists uq_tag_set_user_name
  on public.qiangua_tag_set using btree ("UserId", lower("TagSetName"))
  where type = 'custom'::text
  tablespace pg_default;

create unique index if not exists uq_tag_name_per_set
  on public.qiangua_tag using btree ("TagSetId", lower("TagName"))
  tablespace pg_default;

create index if not exists idx_tag_by_user
  on public.qiangua_tag using btree ("UserId")
  tablespace pg_default;

create index if not exists idx_note_tag_tagid
  on public.qiangua_note_tag using btree ("TagId")
  tablespace pg_default;

create index if not exists idx_note_tag_user
  on public.qiangua_note_tag using btree ("UserId")
  tablespace pg_default;

create trigger trg_normalize_tag_set_name
before insert or update on public.qiangua_tag_set
for each row
execute function public.normalize_tag_set_name();

create trigger trg_normalize_tag_name
before insert or update on public.qiangua_tag
for each row
execute function public.normalize_tag_name();

create trigger trg_set_qiangua_tag_set_updated_at
before update on public.qiangua_tag_set
for each row
execute function public.set_updated_at();

create trigger trg_set_qiangua_tag_updated_at
before update on public.qiangua_tag
for each row
execute function public.set_updated_at();

create trigger trg_set_qiangua_note_tag_updated_at
before update on public.qiangua_note_tag
for each row
execute function public.set_updated_at();
```

#### 3.2 RLS（行级安全）策略

```sql
-- Tag sets: everyone可读系统系列，只有Owner管理自定义系列
alter table public.qiangua_tag_set enable row level security;

create policy "Tag sets readable by owner or system"
  on public.qiangua_tag_set
  for select
  using (
    auth.role() = 'service_role'
    or type = 'system'
    or "UserId" = auth.uid()
  );

create policy "Custom tag sets manageable by owner"
  on public.qiangua_tag_set
  for all using (
    auth.role() = 'service_role'
    or (type = 'custom' and "UserId" = auth.uid())
  )
  with check (
    auth.role() = 'service_role'
    or (type = 'custom' and "UserId" = auth.uid())
  );

-- Tags: 继承所属标签系列的可见性
alter table public.qiangua_tag enable row level security;

create policy "Tags readable via accessible tag sets"
  on public.qiangua_tag
  for select
  using (
    auth.role() = 'service_role'
    or exists (
      select 1
      from public.qiangua_tag_set s
      where s."TagSetId" = public.qiangua_tag."TagSetId"
        and (
          s.type = 'system'
          or s."UserId" = auth.uid()
        )
    )
  );

create policy "Custom tags manageable by owner"
  on public.qiangua_tag
  for all using (
    auth.role() = 'service_role'
    or exists (
      select 1
      from public.qiangua_tag_set s
      where s."TagSetId" = public.qiangua_tag."TagSetId"
        and s.type = 'custom'
        and s."UserId" = auth.uid()
    )
  )
  with check (
    auth.role() = 'service_role'
    or exists (
      select 1
      from public.qiangua_tag_set s
      where s."TagSetId" = public.qiangua_tag."TagSetId"
        and s.type = 'custom'
        and s."UserId" = auth.uid()
    )
  );

-- Note tags: 仅允许笔记操作人访问自己的打标数据
alter table public.qiangua_note_tag enable row level security;

create policy "Note tags readable by owner"
  on public.qiangua_note_tag
  for select
  using (
    auth.role() = 'service_role'
    or "UserId" = auth.uid()
  );

create policy "Note tags writable by owner"
  on public.qiangua_note_tag
  for all using (
    auth.role() = 'service_role'
    or "UserId" = auth.uid()
  )
  with check (
    auth.role() = 'service_role'
    or "UserId" = auth.uid()
  );
```

#### 3.3 表关系说明

- `qiangua_tag_set` 一对多 `qiangua_tag`：同一标签系列下可包含多个标签，删除系列时通过外键 `on delete cascade` 自动清理标签。
- `qiangua_tag` 多对多 `notes`：通过中间表 `qiangua_note_tag` 建立笔记与标签的多对多关系，删除标签或笔记时自动清理关联。
- `qiangua_note_tag` 将操作用户 (`UserId`) 记录为审计字段，可追踪最近一次打标/撤销操作。

#### 3.4 查询优化建议（常用 SQL 示例）

- **按标签系列拉取标签列表**（命中 `uq_tag_name_per_set` 与 `idx_tag_by_user`）：

```sql
select t."TagId", t."TagName"
from public.qiangua_tag t
where t."TagSetId" = :tag_set_id
order by t."TagName";
```

- **查询指定笔记在某系列下的标签**（利用主键与 `idx_note_tag_tagid`）：

```sql
select nt."TagId", t."TagName"
from public.qiangua_note_tag nt
join public.qiangua_tag t on t."TagId" = nt."TagId"
where nt."NoteId" = :note_id
  and t."TagSetId" = :tag_set_id;
```

- **筛选当前用户未打标笔记**（建议结合 `notes` 索引，对 `not exists` 走索引）：

```sql
select n."id", n."title"
from public.notes n
where n."UserId" = auth.uid()
  and not exists (
    select 1
    from public.qiangua_note_tag nt
    join public.qiangua_tag t on t."TagId" = nt."TagId"
    where nt."NoteId" = n."id"
      and t."TagSetId" = :tag_set_id
  )
order by n."created_at" desc
limit 50;
```

- **批量写入笔记标签**（配合 Supabase `rpc` 或批量 insert API，并触发 `UpdatedAt`）：

```sql
insert into public.qiangua_note_tag ("NoteId", "TagId", "UserId")
select unnest(:note_ids), :tag_id, auth.uid()
on conflict ("NoteId", "TagId") do update
set "UpdatedAt" = now(), "UserId" = excluded."UserId";
```

### 4. API 接口设计部分
- [x] 统一的响应格式说明
- [x] 错误响应格式
- [x] 请求参数详细说明（类型、必填、说明）
- [x] 响应数据详细说明
- [x] 错误码定义

#### 4.1 统一的响应格式说明

所有接口都返回以下标准结构：

- `code`：字符串，业务状态码，`0` 表示成功，其它值表示失败
- `message`：字符串，可读性提示，成功时可为 `"OK"`
- `data`：对象或数组，成功响应的具体数据；失败时为 `null`
- `requestId`：字符串，可选，便于追踪日志

```json
{
  "code": "0",
  "message": "OK",
  "data": { "example": "value" },
  "requestId": "2025-11-12T06:24:35.123Z-8712"
}
```

#### 4.2 错误响应格式

失败时遵循统一结构，`code` 使用下文定义的错误码，`errors` 列出字段级错误（如有）。

```json
{
  "code": "TAG_SET_NOT_FOUND",
  "message": "标签系列不存在",
  "data": null,
  "errors": [
    {
      "field": "tagSetId",
      "reason": "指定的标签系列已被删除"
    }
  ],
  "requestId": "2025-11-12T06:24:35.123Z-8712"
}
```

#### 4.3 接口列表与请求参数

##### GET `/api/tag-sets`
- **说明**：拉取当前用户可见的标签系列（包含系统系列）
- **认证**：需要 Supabase JWT（`Authorization: Bearer <token>`）
- **查询参数**：

| 参数 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `includeSystem` | boolean | 否 | 是否包含系统标签系列，默认 `true` |
| `withTags` | boolean | 否 | 是否联带返回标签列表，默认 `false` |

- **响应 `data`**：

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `items` | `TagSetDTO[]` | 标签系列列表 |

`TagSetDTO` 结构：

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `tagSetId` | uuid | 标签系列 ID |
| `tagSetName` | string | 标签系列名称 |
| `type` | string | `system` 或 `custom` |
| `userId` | uuid/null | 创建者用户 ID，系统系列为 null |
| `tags` | `TagDTO[]` | 当 `withTags=true` 时返回，默认 `[]` |

`TagDTO` 结构：

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `tagId` | uuid | 标签 ID |
| `tagName` | string | 标签名称 |
| `updatedAt` | string | 最近更新时间（ISO8601） |

##### POST `/api/tag-sets`
- **说明**：创建自定义标签系列及初始标签
- **请求体**：

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `tagSetName` | string | 是 | 标签系列名称 |
| `tags` | string[] | 否 | 初始标签名称列表，允许为空数组 |

- **响应 `data`**：返回新建的 `TagSetDTO`（含 `tags`）

##### PATCH `/api/tag-sets/{tagSetId}`
- **说明**：重命名自定义标签系列
- **请求体**：

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `tagSetName` | string | 是 | 新名称 |

- **响应 `data`**：更新后的 `TagSetDTO`

##### DELETE `/api/tag-sets/{tagSetId}`
- **说明**：删除自定义标签系列，级联删除标签及关联
- **响应 `data`**：`{ "deleted": true }`

##### POST `/api/tags`
- **说明**：在指定系列下创建标签
- **请求体**：

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `tagSetId` | uuid | 是 | 所属标签系列 |
| `tagName` | string | 是 | 标签名称 |

- **响应 `data`**：新建的 `TagDTO`

##### PATCH `/api/tags/{tagId}`
- **说明**：重命名标签（仅限自定义系列）
- **请求体**：

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `tagName` | string | 是 | 新名称 |

- **响应 `data`**：更新后的 `TagDTO`

##### DELETE `/api/tags/{tagId}`
- **说明**：删除标签并清理笔记关联
- **响应 `data`**：`{ "deleted": true }`

##### GET `/api/notes/{noteId}/tags`
- **说明**：查询指定笔记在某系列下的标签
- **查询参数**：

| 参数 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `tagSetId` | uuid | 是 | 标签系列 ID |

- **响应 `data`**：

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `noteId` | uuid | 笔记 ID |
| `tagSetId` | uuid | 标签系列 ID |
| `tags` | `TagDTO[]` | 已关联标签 |

##### POST `/api/notes/tagging`
- **说明**：为单篇笔记覆盖打标（幂等）
- **请求体**：

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `noteId` | uuid | 是 | 笔记 ID |
| `tagSetId` | uuid | 是 | 标签系列 ID |
| `tagIds` | uuid[] | 是 | 期望保持的标签 ID 列表，空数组表示清空 |

- **响应 `data`**：与 GET `/api/notes/{noteId}/tags` 相同

##### POST `/api/notes/tagging/bulk`
- **说明**：批量为多篇笔记添加标签（追加）
- **请求体**：

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `noteIds` | uuid[] | 是 | 笔记 ID 列表 |
| `tagSetId` | uuid | 是 | 标签系列 ID |
| `tagIds` | uuid[] | 是 | 待追加的标签 ID 列表 |

- **响应 `data`**：

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `succeedCount` | number | 成功打标的笔记数量 |
| `failed` | `Array<{noteId: uuid, reason: string}>` | 失败详情 |

##### DELETE `/api/notes/tagging/bulk`
- **说明**：批量清除指定笔记在某系列下的全部标签
- **请求体**：

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `noteIds` | uuid[] | 是 | 笔记 ID 列表 |
| `tagSetId` | uuid | 是 | 标签系列 ID |

- **响应 `data`**：`{ "succeedCount": number, "failed": Array<{noteId, reason}> }`

#### 4.4 响应数据详细说明

- 所有 `uuid` 字段均返回字符串格式的 UUID v4
- `updatedAt` / `createdAt` 字段（如 `TagDTO.updatedAt`）使用 ISO8601 字符串
- `succeedCount`、`failed` 等统计字段为数字，客户端需处理部分失败场景（提示用户手动重试）
- `errors` 数组仅在校验失败或业务失败（非系统异常）时出现，前端可用于展示字段级错误

#### 4.5 错误码定义

| 错误码 | 场景 | HTTP 状态码 | 说明 |
| --- | --- | --- | --- |
| `UNAUTHORIZED` | 未携带登录凭证 | 401 | Supabase 鉴权失败 |
| `FORBIDDEN` | 无权访问资源 | 403 | 例如访问他人自定义标签系列 |
| `TAG_SET_NOT_FOUND` | 标签系列不存在 | 404 | `tagSetId` 无效 |
| `TAG_NOT_FOUND` | 标签不存在 | 404 | `tagId` 无效 |
| `NOTE_NOT_FOUND` | 笔记不存在 | 404 | `noteId` 无效 |
| `TAG_SET_NAME_CONFLICT` | 标签系列名称重复 | 409 | 与现有自定义标签系列冲突 |
| `TAG_NAME_CONFLICT` | 标签名称重复 | 409 | 同系列下名称重复 |
| `VALIDATION_FAILED` | 参数校验失败 | 422 | 请求体字段不符合约束 |
| `LIMIT_EXCEEDED` | 超过批量操作上限 | 422 | 例如 `noteIds` 超出 500 条 |
| `INTERNAL_ERROR` | 未知错误 | 500 | 记录日志并提示稍后重试 |

### 5. 前端页面设计部分
- [x] 设计原则说明
- [x] 技术组件说明（使用的 antd 组件）
- [x] 详细的 UI 布局结构（ASCII 图或文字描述）
- [x] 交互状态说明（加载、错误、成功）
- [x] 组件使用说明
- [x] 设计确认清单

#### 5.1 设计原则说明
- **一致性**：整体视觉与交互保持与 `/dashboard/reports` 等现有后台模块一致（色板、排版、按钮样式）。
- **可读性**：表格列宽、标签列采用固定宽度与换行处理，确保标签信息清晰可辨。
- **高效操作**：常用操作（选择标签系列、批量打标）置于视线焦点区域；键盘操作（Enter 保存、Esc 取消）保持一致。
- **反馈明确**：操作完成后使用 `message`、`notification` 与表格局部刷新同步反馈。

#### 5.2 技术组件说明
- 页面基础采用 `Next.js App Router` + `React 18`。
- 核心 antd 组件：
  - `Layout`, `Space`, `Card`：页面结构与模块分区。
  - `Form`, `Select`, `DatePicker`, `Switch`：筛选区控件。
  - `Table`, `Tag`, `Checkbox`, `Tooltip`：笔记列表与标签展示。
  - `Drawer`（移动端可选）或 `Modal`：批量操作弹窗。
  - `Spin`, `Empty`, `Result`, `Alert`, `Message`, `Notification`: 状态反馈。
  - `App`（`App.useApp()`）统一处理消息反馈与全局 Loading。

#### 5.3 UI 布局结构

```
桌面端（1200px+）
+--------------------------------------------------------------------------------+
| 顶部全局导航（沿用主布局）                                                     |
+--------------------------+-----------------------------------------------------+
| 左栏（固定 280px）       | 主工作区                                            |
| - 全局菜单               | +-------------------------------------------------+ |
|                          | | 顶部筛选卡片：TagSet Selector（必选）          | |
|                          | +-------------------------------------------------+ |
|                          | | 二级筛选卡片：品牌 / 博主 / 日期 / 我的报告    | |
|                          | |             + Tag Filter（未打标 & 标签列表）   | |
|                          | +-------------------------------------------------+ |
|                          | | 批量操作工具栏（浮动，选中≥1显示）              | |
|                          | +-------------------------------------------------+ |
|                          | | 笔记表格（可滚动区域，右侧固定标签编辑列）     | |
|                          | +-------------------------------------------------+ |
|                          | | 底部分页 / 数据量提示                           | |
|                          | +-------------------------------------------------+ |
+--------------------------+-----------------------------------------------------+
```

#### 5.4 交互状态说明
- **加载**：
  - 页面初始：主表格与筛选区显示骨架屏或 `Spin`。
  - 保存标签：目标单元格与批量工具栏按钮进入 loading，页面其余部分可继续操作。
- **成功**：
  - 单笔保存：使用 `App.useApp().message.success`，表格行内标签即时更新。
  - 批量操作：`notification.success` 显示成功 / 失败数量。
- **错误**：
  - 网络 / 接口异常：`Result` 组件覆盖表格区域，提供重试按钮。
  - 字段校验：`Form.Item` 显示红色错误提示；批量失败列表在弹窗内展示。

#### 5.5 组件使用说明
- `TagSeriesSelect`：封装 `Select`，负责加载可用的标签系列，支持缓存与搜索。
- `NoteTagEditor`：表格右侧列组件，控制标签选择与保存逻辑，使用 `Select` 多选模式。
- `BulkTaggingModal`：批量打标弹窗，内部复用 `NoteTagEditor` 的多选组件。
- `BulkClearConfirm`：二次确认 `Modal`，展示选中笔记数量与影响范围。
- `FiltersPanel`：封装筛选表单，支持受控状态与 URL 同步。
- 所有组件通过 `QueryClient`（tanstack-query）共享缓存，避免重复请求。

#### 5.6 设计确认清单
- [x] 笔记打标页面在桌面端可高效操作。
- [x] 筛选区与表格列对齐，标签列固定不滚动。
- [x] 单笔与批量操作的交互反馈一致（消息 + 刷新）。
- [x] 错误提示明确指向失败原因，可重试。
- [x] 系统标签系列显示只读状态（禁用编辑按钮）。
- [x] 自定义系列的管理入口可从标签管理页面跳转。

#### 5.7 标签系列管理页面设计
- **页面入口**：导航 `内容标签化 > 标签管理`，面包屑与 `Tags` 模块保持一致。
- **布局结构**：
  - 左侧窄栏（220px）复用全局菜单。
  - 主内容采用 `Card` 分区，上方为系列筛选与操作栏，下方为系列列表表格。
  - 桌面端布局示意：

    ```
    +--------------------------------------------------------------------------------+
    | 顶部全局导航                                                                    |
    +-------------+------------------------------------------------------------------+
    | 侧边导航栏  | 主工作区                                                           |
    |             | | 系列表格：名称 | 类型 | 标签预览 | 更新时间 | 操作         | |
    |             | +--------------------------------------------------------------+ |
    |             | | 分页器 / 数据概览                                             | |
    |             | +--------------------------------------------------------------+ |
    +-------------+------------------------------------------------------------------+
    ```

- **筛选与操作栏**：
  - 系统 / 自定义系列切换 `Tabs`（默认展示全部）。
  - `Search` 输入框支持系列名称 / 标签名称模糊搜索。
  - `Button` 组包含 `新建标签系列`（primary）与 `刷新`。
- **系列列表表格**：
  - 列结构：`系列名称`、`类型`（系统/自定义）、`标签预览`（全部标签逗号分隔）、`最近更新时间`、`操作`（编辑 / 删除）。
  - 系统系列的 `编辑`、`删除` 操作置灰并提供 `Tooltip` 说明；自定义系列支持正常点击。
- **空状态与分页**：
  - 无系列时展示 `Empty`，提供“新建标签系列”引导。
  - 表格底部提供分页组件，默认 20 条每页，支持记忆用户选择。
- **弹窗交互**：
  - `新建 / 编辑系列` 使用 `Modal` + 表单，左侧为系列基本信息（名称、描述可选），右侧为标签列表编辑区。
  - 标签列表支持增删行、拖拽排序（可选），新增行先展示占位后进入编辑态。
  - `删除系列` 弹窗强调级联影响，需输入系列名称确认。
  - `查看标签` 弹窗或 `Drawer` 展示标签详情、操作记录（最近更新人 / 时间）。
- **提示与反馈**：
  - 所有成功操作使用 `message.success`；删除成功后将行淡出再刷新。
  - 校验失败时在表单内联显示错误，标签重复时高亮对应行。
  - 网络错误使用 `Alert` 组件顶栏展示，允许重试。
  - 当 RLS 导致无权限编辑时，按钮禁用并提供 `Tooltip` 说明。

##### 5.7.1 关键交互流程
- **创建标签系列**：
  1. 点击操作栏 `新建标签系列` 按钮，打开 `Modal`。
  2. `Modal` 布局、输入控件与 `编辑标签系列` 对话框一致（参考 5.7.2），默认标题为“新建标签系列”，表单为空态。
  3. 在 `Form` 中填写系列名称、添加初始标签（动态行，支持 `+ 添加标签`）。
  4. 校验通过后点击 `保存`，提交成功关闭弹窗，表格顶部插入新行并以高亮背景强调 3 秒。
  5. 若失败，表单内显示错误信息；`Modal` 底部展示错误提示，允许重试。
- **编辑标签系列**：
  1. 在目标行点击 `编辑`，打开与创建相同的 `Modal`，预填现有数据。
  2. Modal 顶部展示系列名称输入框，支持即时校验（重复、为空时禁用保存）。
  3. 标签编辑区按行展示标签名、别名、颜色等字段，并提供 `删除` 图标按钮；行内编辑失焦即校验。
  4. Modal 底部 `保存`、`取消` 按钮固定，可展示保存进度；提交成功后关闭弹窗并触发 `message.success`。
- **删除标签系列**：
  1. 点击 `删除` 按钮，弹出确认对话框，展示影响范围（xx 个标签、xx 条笔记打标）。
  2. 用户需输入系列名称确认（防止误删），按钮在校验通过后变为可点击。
  3. 删除成功后，行使用 `motion.div` 动画淡出，随后刷新列表。
  4. 删除失败时，保留行并在行首使用 `Alert` 提示原因（权限不足等）。

##### 5.7.2 `编辑标签系列` Modal 布局示意

```
+--------------------------------------------------------------------------------+
| 标题栏：编辑标签系列                               关闭按钮 [X]                |
+--------------------------------------------------------------------------------+
| 主体内容区（上下结构，可滚动）                                                     |
| +--------------------------------------------------------------------------+ |
| | 系列基础信息（Section 1）                                               | |
| | --------------------------------------------                            | |
| | 名称输入框（必填，失焦校验，内联错误提示）                              | |
| +--------------------------------------------------------------------------+ |
| | 标签配置列表（Section 2）                                                | |
| | 工具条：`+ 添加标签` 主按钮                                  | |
| | 表头吸顶：标签名 | 操作（删除）                                        | |
| | 行内容：标签名输入框 / 删除图标                                        | |
| | 行级校验提示展示在每行下方                                               | |
| | 空态：Illustration + “暂无标签，点击上方按钮添加”                        | |
| +--------------------------------------------------------------------------+ |
+--------------------------------------------------------------------------------+
| 底部操作区（固定）：左侧最近操作记录入口；右侧 [取消] [保存 | loading]          |
+--------------------------------------------------------------------------------+
| Modal 底部错误条（可选）：保存失败时展示，可包含“重试”按钮                              |
+--------------------------------------------------------------------------------+
```

- 关闭按钮触发未保存更改时弹出二次确认（`Popconfirm`）。
- 主体内容区纵向滚动，标题栏与底部操作区固定；标签列表表头吸顶。
- 标签行 Hover 显示拖拽手柄，排序成功后展示轻量 `message.success`。
- 删除操作需二次确认；确认后按钮进入 loading，成功移除并自动滚动至首行。
- `保存` 按钮根据校验状态启用/禁用；提交中显示 loading 防止重复点击。

##### 5.7.3 状态与空态处理
- **加载中**：列表首次加载显示骨架屏；分页切换时表体置灰 + 内联 `Spin`。
- **无匹配数据**：`Tabs` 或搜索无结果时显示 `Empty`，提示“未找到匹配的标签系列”，附带“重置筛选”按钮。
- **部分加载失败**：列表加载失败显示全宽 `Result`，提供“重试”按钮；`Drawer` 内数据拉取失败时在内容区显示 `Alert`，`Drawer` 不自动关闭。
- **权限受限**：当用户仅具备只读权限时，操作栏的 `新建` 按钮隐藏，行内 `编辑`/`删除` 按钮禁用并附提示“仅管理员可操作”。

### 6. 测试相关
- [x] 测试用例链接或说明
- [x] 测试场景描述

#### 6.1 测试用例链接或说明
- 关联文档：`../../04_质量保证/02_测试用例/笔记标签化功能测试用例.md`
- 临时追踪：使用 `Jira` 标签 `NOTE-TAGGING` 记录自动化与手测结果。

#### 6.2 测试场景描述
- **标签系列 CRUD**：创建、重命名、删除自定义系列；系统系列只读验证。
- **标签 CRUD**：新增、重命名、删除标签；重复名称校验。
- **单笔打标**：新增、覆盖、清空标签，确认后端记录 `UserId`。
- **批量打标 / 清除**：成功、部分失败（模拟权限/已删除）、超出批量上限。
- **筛选逻辑**：未打标默认、按单个标签筛选、与其他条件组合、无结果提示。
- **RLS 权限**：使用不同用户访问验证只读与可写范围。
- **回归测试**：与报告模块共享 API 基础设施的回归，确保未破坏其它功能。

### 7. 实现文件链接
- [x] 组件实现路径索引（参考 `组件实现路径索引.md`）
- [x] API 路由路径
- [x] 数据库脚本路径

- `前端组件`：
  - 标签管理页面：`/Users/stone/Desktop/crx_projects/xhsCompetitorNote_website/app/dashboard/tags/page.tsx`（计划新建）
  - 笔记打标页面：`/Users/stone/Desktop/crx_projects/xhsCompetitorNote_website/app/dashboard/notes/tagging/page.tsx`（计划新建）
  - 公共组件：`/Users/stone/Desktop/crx_projects/xhsCompetitorNote_website/components/reports/`（复用弹窗、表格组件）
- `API 路由`：
  - 标签系列：`/Users/stone/Desktop/crx_projects/xhsCompetitorNote_website/app/api/tag-sets/`
  - 标签：`/Users/stone/Desktop/crx_projects/xhsCompetitorNote_website/app/api/tags/`
  - 笔记打标：`/Users/stone/Desktop/crx_projects/xhsCompetitorNote_website/app/api/notes/tagging/`
- `数据库脚本`：
  - 表结构 & RLS：`/Users/stone/Desktop/crx_projects/xhsCompetitorNote_website/scripts/note-tagging-schema.sql`（待创建）
  - 数据初始化：`/Users/stone/Desktop/crx_projects/xhsCompetitorNote_website/scripts/note-tagging-init.sql`

### 8. 其他
- [x] 数据初始化脚本的完整 SQL（不只是说明）
- [x] 数据迁移方案（如果需要）
- [x] 版本兼容性说明

#### 8.1 数据初始化脚本

```sql
-- scripts/note-tagging-init.sql
begin;

insert into public.qiangua_tag_set ("TagSetId", "TagSetName", type, "UserId")
values
  ('00000000-0000-0000-0000-000000000001', '内容场景', 'system', null)
on conflict ("TagSetId") do nothing;

insert into public.qiangua_tag ("TagId", "TagSetId", "TagName", "UserId")
values
  ('00000000-0000-0000-0000-00000000c001', '00000000-0000-0000-0000-000000000001', '品牌品宣', null),
  ('00000000-0000-0000-0000-00000000c002', '00000000-0000-0000-0000-000000000001', '明星代言', null),
  ('00000000-0000-0000-0000-00000000c003', '00000000-0000-0000-0000-000000000001', '穿搭叙事', null),
  ('00000000-0000-0000-0000-00000000c004', '00000000-0000-0000-0000-000000000001', '明星同款私服', null),
  ('00000000-0000-0000-0000-00000000c005', '00000000-0000-0000-0000-000000000001', '创意手绘视频', null),
  ('00000000-0000-0000-0000-00000000c006', '00000000-0000-0000-0000-000000000001', '创意舞蹈视频', null)
on conflict ("TagId") do nothing;

commit;
```