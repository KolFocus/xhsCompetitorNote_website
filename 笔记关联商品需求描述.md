# 笔记关联商品需求描述

> 参考文档：`基于内容标签的笔记分析` 模块。实现给笔记关联推广商品的功能，支持商品管理、关联操作、统计分析等能力。

## 1. 功能概述

- AI 分析后生成“笔记商品列表”（按笔记提取的候选商品），需为每条记录绑定归属商品。当前信息待确认自 AI 抽取，需再查 AI 分析代码以明确字段（名称/链接/图片/品牌来源）。
- 商品必须归属品牌，去重键为 BrandId + BrandName（同 BrandId 多 BrandName 也需带 BrandName 一起判定）。
- 提供“商品关联”页面，展示笔记商品列表（布局类似笔记标签页：笔记信息、AI 分析结果、当前商品、编辑）。一条记录只能关联一个商品。
- 筛选项：品牌、笔记ID、状态（待处理=未绑定且未忽略；已忽略=绑定特殊 UUID 如 000-0000…，UI 直接显示“已忽略”；已处理=已绑定正常商品 UUID）、搜索词（复杂搜索 +词/-词/OR，且高亮；仅搜商品名称）。
- 批量操作：支持批量关联/批量忽略。批量关联前提：选中记录品牌一致（按 BrandId + BrandName）。批量关联弹窗可新建商品（至少需商品标准名称，需做去重校验；品牌已在进入时确定）。
- 列表交互：分页查看，默认按笔记发布时间排序；商品库共享，无需权限隔离。
- 状态派生：不存独立状态字段，状态由 LinkedProductId 派生，pending/linked/ignored 可相互切换（覆盖绑定、设忽略或清空）。

## 2. 核心功能

### 2.1 商品管理（新增/维护商品库）
- 商品信息：商品标准名称（必填、需去重），可选：商品链接、商品图片、商品描述。创建时需绑定品牌（BrandId+BrandName）。
- 去重规则：同一品牌下商品标准名称需唯一（按品牌去重即可）。
- 编辑/删除：允许编辑名称/链接/图片/描述；不可删除（若已有笔记关联禁止删除）。
- 列表能力：简单搜索（按商品名称，不支持复杂语法）、分页，排序默认按创建时间。品牌维度商品不多，可下拉选择。

### 2.2 笔记商品列表（候选记录）
- 展示 AI 抽取的候选商品列表，字段至少含：笔记信息（标题/封面/发布时间/AI 结果摘要）、候选商品名称（AI 抽取）、品牌（BrandId+BrandName），当前关联状态/商品。
- 过滤与搜索：品牌筛选；笔记ID筛选；状态筛选（待处理/已忽略/已处理）；复杂搜索仅针对“候选商品名称”（+词/-词/OR，高亮）。
- 列表样式：对齐“笔记标签”页，包含操作入口（单条编辑、批量选择）。
- 状态定义：待处理=未绑定且未忽略；已忽略=绑定特殊 UUID，UI 显示“已忽略”；已处理=绑定正常商品 UUID。

### 2.3 笔记关联商品（单条）
- 操作：为单条候选记录选择已有商品并绑定，支持覆盖原绑定；可设为已忽略（绑定特殊 UUID）；可取消关联（清空 LinkedProductId，回到 pending）。
- 约束：一条记录仅能关联一个商品；品牌必须一致（BrandId+BrandName）。

### 2.4 批量关联/忽略
- 批量选择：仅在所选记录品牌一致（按 BrandId+BrandName）时允许批量关联；否则需提示不可批量。
- 批量关联：商品需已存在（批量不支持新建）；选择后可批量绑定并覆盖原绑定。
- 批量忽略：批量将状态置为已忽略（绑定特殊 UUID），UI 显示“已忽略”。
- 批量取消关联：批量清空 LinkedProductId，状态回到 pending。

### 2.5 （本期不支持的功能已移除）

## 3. 数据计算规则

### 3.1 状态判定
- 待处理：未绑定商品且未标记忽略。
- 已忽略：绑定特殊 UUID（如 000-0000…），UI 显示“已忽略”。
- 已处理：已绑定正常商品 UUID。

### 3.2 去重与唯一性
- 品牌唯一键：BrandId + BrandName。
- 商品唯一键：同一品牌下，商品标准名称唯一（按品牌去重）。
- 笔记商品记录：一条候选记录只允许绑定一个商品或被忽略。

### 3.3 过滤/搜索规则
- 品牌筛选：按 BrandId + BrandName。
- 笔记ID筛选：精确匹配 NoteId。
- 状态筛选：按 3.1 定义。
- 关键词搜索：仅作用于候选商品名称，支持 +词 / -词 / OR 组，匹配部分高亮。

### 3.4 批量操作约束
- 批量关联前提：所选记录品牌一致（BrandId + BrandName）。
- 批量新建商品时品牌已确定：只需商品标准名称（需按品牌去重），其他字段可选。
- 批量忽略：统一绑定特殊 UUID，状态变更为已忽略。

### 3.5 列表排序/分页
- 排序：默认按笔记发布时间降序。
- 分页：对候选列表分页；商品列表同样分页（商品量不大，可下拉选择）。

### 3.6 未实现项（首期不做）
- 商品维度统计、导出不纳入首期；若后续补充，再定义统计口径（按商品聚合笔记数/互动/金额、未关联笔记量等）。

## 4. 技术实现

### 4.0 数据与表结构（待确认/复用）
- 商品表：`qiangua_product`（或新表名），字段示例：ProductId（PK, uuid）、ProductName（按 BrandId+BrandName 唯一）、BrandId、BrandName、ProductLink（可选）、ProductImage（可选）、ProductDesc（可选）、CreatedAt、UpdatedAt。
- 笔记商品候选表：存储 AI 抽取结果，字段示例：Id（PK, uuid）、NoteId、ProductAliasName（候选商品名）、BrandId、BrandName、LinkedProductId（正常商品 uuid 或特殊忽略 uuid，用于派生状态）、CreatedAt、UpdatedAt。
- 特殊忽略 UUID：固定常量（如 `00000000-0000-0000-0000-000000000000`），前后端共享。

### 4.1 API 设计（建议）
- 商品管理：
  - `GET /api/products?brandId&brandName&keyword&page&pageSize`（简单搜索按商品名，分页，默认创建时间倒序）。
  - `POST /api/products`（ProductName 必填 + BrandId+BrandName；可选 Link/Image/Desc；校验同品牌去重）。
  - `PUT /api/products/:id`（编辑名称/链接/图片/描述；保持去重约束）。
  - `DELETE /api/products/:id`（首期不支持，若保留接口需校验无关联，否则禁止）。
- 笔记商品候选列表：
  - `GET /api/note-products?brandId&brandName&noteId&status&keyword&page&pageSize`（keyword 支持 +词/-词/OR，仅搜候选商品名；状态由 LinkedProductId 派生）。
- 单条关联/忽略/取消：
  - `PUT /api/note-products/:id/link`（body: productId；校验品牌一致；绑定/更新 LinkedProductId 为指定商品，覆盖原绑定）。
  - `PUT /api/note-products/:id/ignore`（绑定特殊 UUID，状态设 ignored）。
  - `PUT /api/note-products/:id/unlink`（清空 LinkedProductId，状态回到 pending）。
- 批量关联/忽略/取消：
  - `POST /api/note-products/batch/link`（ids[], productId；校验品牌一致；允许覆盖原绑定；商品需已存在，不支持同时新建）。
  - `POST /api/note-products/batch/ignore`（ids[]，批量设 ignored）。
  - `POST /api/note-products/batch/unlink`（ids[]，批量清空 LinkedProductId，状态回到 pending）。

### 4.2 前端页面/组件
- 商品关联页面：列表 + 筛选（品牌、笔记ID、状态、搜索）；表格列含笔记信息、AI 摘要、候选商品名、高亮、当前关联商品/状态、操作（单条关联/忽略）。
- 商品选择/新建弹窗：批量场景支持新建（仅商品名必填，自动带品牌；去重校验）；单条仅选择已有商品。
- 搜索语法：沿用 +词/-词/OR，高亮命中词；仅作用于候选商品名。
- 状态展示：pending/linked/ignored；ignored 直接显示“已忽略”。
- 交互约束：批量关联前先校验品牌一致；分页、排序（笔记发布时间降序）。

### 4.3 校验与业务规则
- 品牌一致性：NoteProduct.BrandId+BrandName 必须与 Product.BrandId+BrandName 匹配。
- 去重：创建/新建商品时按品牌+商品名判重；批量新建前先查重。
- 状态流转：无专门状态字段，由 LinkedProductId 派生；pending（LinkedProductId 为空） ↔ linked（绑定正常商品 UUID） ↔ ignored（忽略 UUID），三者可互相切换/覆盖。

### 4.4 性能与安全
- 列表查询分页；关键词过滤在后端处理（避免前端大列表）。
- 简单鉴权/权限：商品库共享，无需隔离；仍需登录校验。
- 常量下发：忽略 UUID 由后端配置并返回，前端不硬编码（建议）。

## 5. 实现计划

### 5.1 数据库设计
- 建表/调整：商品表（ProductId/Name/BrandId/BrandName/可选 Link/Image/Desc/时间戳）、笔记商品候选表（Id/NoteId/ProductAliasName/BrandId/BrandName/LinkedProductId/时间戳）。
- 约束：商品名在同品牌下唯一；候选表 LinkedProductId 支持 null/忽略 UUID/正常 UUID。
- 常量：忽略 UUID 配置为常量，下发前端。

### 5.2 后端实现
- 商品接口：GET/POST/PUT `/api/products`，暂不支持 DELETE；按品牌去重校验。
- 候选列表接口：GET `/api/note-products`（筛选品牌/笔记ID/关键词/状态=由 LinkedProductId 派生）。
- 关联/忽略接口：PUT `/api/note-products/:id/link`（覆盖绑定），PUT `/api/note-products/:id/ignore`（设忽略 UUID）。
- 批量接口：POST `/api/note-products/batch/link`（覆盖绑定，商品需已存在），POST `/api/note-products/batch/ignore`。
- 搜索语法：后端支持 +词/-词/OR 仅作用于 ProductAliasName。

### 5.3 前端实现
- 页面：新增“商品关联”页面（列表、筛选、单条关联/忽略、批量关联/忽略）。
- 组件：商品选择弹窗（批量可选已有商品，不支持新建），状态展示/高亮，复杂搜索输入。
- 交互：批量前校验同品牌；单条/批量均可覆盖绑定；状态由 LinkedProductId 派生并可切换。
- 排序分页：默认按笔记发布时间降序，列表分页；商品选择支持下拉搜索。

### 5.4 测试验证
- 用例：状态切换（pending/ignored/linked 互转）、同品牌校验、去重校验、批量覆盖、忽略流程、搜索语法命中/高亮。
- 边界：空列表、全忽略、重复绑定覆盖、品牌不一致禁止批量、忽略 UUID 常量传递。
- 性能：列表分页查询正常；无大表聚合（本期无统计/导出）。

## 6. 前端示意与交互说明

### 6.1 页面结构示意（线框）
```
商品关联页
┌──────────────────────────────────────────────┐
│ 筛选区：品牌选择 | 笔记ID | 状态(待处理/已忽略/已处理) | 关键词(商品名 +词/-词/OR) │
│ 按钮：批量关联（置灰：品牌不一致时） | 批量忽略 │
├──────────────────────────────────────────────┤
│ 列表（分页，按笔记发布时间倒序）                                          │
│ ┌───┬────────┬──────────┬───────────┬───────────┬───────────┐ │
│ │选 │ 笔记信息 │ AI 摘要   │ 候选商品名 │ 当前绑定商品 │ 状态/操作 │ │
│ └───┴────────┴──────────┴───────────┴───────────┴───────────┘ │
│ 行操作：关联（选择已有商品，覆盖绑定） | 忽略（设忽略 UUID）        │
└──────────────────────────────────────────────┘

批量关联弹窗（仅同品牌可打开；支持新建商品）
┌───────────────────────────────┐
│ 选择/新建商品（同品牌）             │
│ [ 下拉框：商品名称 (按创建时间排序) ] │
│ [ 新建商品按钮（弹出简洁表单，仅商品名必填，带品牌；去重校验） ] │
│                                  │
│ [确认关联并覆盖]   [取消] │
└───────────────────────────────┘

批量取消关联弹窗（仅同品牌可打开）
┌───────────────────────────────┐
│ 确认将所选记录取消关联，状态回到 pending │
│                                  │
│ [批量取消关联]   [取消]          │
└───────────────────────────────┘
```

### 6.2 交互说明
- 筛选：品牌、笔记ID、状态、关键词（仅商品名，支持 +词/-词/OR，高亮命中）。
- 列表：多选仅在同品牌记录时启用批量关联/取消关联；批量忽略不限品牌。
- 单条关联/取消/忽略：选择已有商品绑定并覆盖；可清空绑定回到 pending；可设忽略。
- 批量关联/取消/忽略：同品牌可批量绑定覆盖或批量取消关联；忽略不限品牌。
- 状态展示：pending（无绑定）、ignored（忽略 UUID，显示“已忽略”）、linked（有商品绑定）；三者可互相切换。
- 验证/提示：品牌不一致时禁用批量关联/取消；提交失败时 toast 提示；覆盖/取消需轻提示。

## 7. 参考文档

## 8. 附：建表 SQL（PostgreSQL 参考）
```sql
-- 商品表
CREATE TABLE IF NOT EXISTS qiangua_product (
  "ProductId" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  "ProductName" TEXT NOT NULL,
  "BrandId" VARCHAR(64) NOT NULL,
  "BrandName" VARCHAR(200) NOT NULL,
  "ProductLink" TEXT,
  "ProductImage" TEXT,
  "ProductDesc" TEXT,
  "CreatedAt" TIMESTAMPTZ NOT NULL DEFAULT now(),
  "UpdatedAt" TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT uq_product_brand UNIQUE ("BrandId", "BrandName", "ProductName")
);

CREATE INDEX idx_product_brandid ON qiangua_product ("BrandId");

-- 笔记商品候选表（AI 抽取结果）
CREATE TABLE IF NOT EXISTS qiangua_note_product_candidate (
  "Id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  "NoteId" VARCHAR(64) NOT NULL,
  "ProductAliasName" TEXT NOT NULL,
  "BrandId" VARCHAR(64) NOT NULL,
  "BrandName" VARCHAR(200) NOT NULL,
  "LinkedProductId" UUID, -- null=pending；忽略 UUID=ignored；其他=linked
  "CreatedAt" TIMESTAMPTZ NOT NULL DEFAULT now(),
  "UpdatedAt" TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_np_noteid ON qiangua_note_product_candidate ("NoteId");
CREATE INDEX idx_np_brandid ON qiangua_note_product_candidate ("BrandId");
CREATE INDEX idx_np_linkedproduct ON qiangua_note_product_candidate ("LinkedProductId");
```

## 9. 开发前确认清单
- 忽略 UUID：是否固定使用 `00000000-0000-0000-0000-000000000000`，需不需要后端配置下发？
答：固定使用 `00000000-0000-0000-0000-000000000000`；后端配置下发。

- 品牌键：接口与前端均使用 BrandId + BrandName 作为唯一键并做校验，是否确认？
答：确认。

- 新建商品入口：单条不新建；批量弹窗可新建（仅商品名必填，带品牌，需去重）；商品管理页可新建。是否还有其他入口？
答：现在没有商品管理页。没有其他入口。

- 覆盖/切换规则：单条/批量关联允许覆盖已有绑定；忽略/取消关联可从任意状态切换。是否需要二次确认弹窗或提示级别要求？
答：需要 二次确认。

- 搜索语法：候选列表关键词仅作用于 ProductAliasName，支持 +词/-词/OR，并高亮；商品列表搜索为简单包含（无复杂语法）。是否确认？
答：候选列表关键词仅作用于 ProductAliasName；没有 商品列表，因此也没搜索的说法。

- 分页/排序默认：候选列表按笔记发布时间倒序；默认 page/pageSize 是否指定（如 1/20）？商品下拉按创建时间排序，是否确认？
答：确认。

- 字段校验：BrandName/ProductName/ProductAliasName 的最大长度/必填规则，是否要禁止全空白或全符号？Link/Image 是否需基本格式校验？
答：不设 最大长度；必填规则；禁止空白和全符号；Link、Image暂时没用上。

- 删除商品：本期不支持删除，是否锁死删除接口（或保留但禁止有绑定时删除）？
答：不支持删除，不需要锁死。

- 批量取消关联：是否同品牌约束？（当前设计：同品牌校验后才可批量取消）
答：批量取消关联，不需要同品牌约束。

- 前端提示：覆盖、取消、忽略时的提示方式（toast/气泡确认）有无偏好？
答：无偏好。