# 基于内容标签的笔记分析

> 参考文档：`达人矩阵属性分析` 模块。从内容标签维度对笔记进行统计分析，数据维度与达人矩阵分析基本一致。

## 1. 功能概述

基于内容标签的笔记分析功能用于从标签维度对报告中的笔记进行统计分析。与达人矩阵分析类似，该功能提供标签维度的数据聚合、占比计算和明细导出能力，帮助用户了解不同标签下的内容表现。

**功能位置**：
- **分析模块**：位于报告详情页面，与"达人矩阵属性分析"模块并列展示

**功能作用**：
- 按标签维度统计笔记数量、互动量、合作金额等核心指标
- 支持标签系列选择，可切换不同标签体系进行分析
- 提供标签维度的数据占比分析，便于识别高价值标签
- 支持快速跳转到打标页面，限定标签系列和报告范围进行打标操作
- 支持导出Excel，包含汇总和明细两个sheet

## 2. 核心功能

### 2.1 标签系列选择

- **标签系列选择器**：位于分析模块顶部，支持选择系统标签系列或用户自定义标签系列
- **默认选择**：
  - 如果用户之前选择过标签系列，从localStorage恢复上次选择（仅限当前报告，优先级最高）
  - 如果localStorage中没有保存的选择，首次进入时优先选择系统标签系列"内容场景"（如果存在）
  - 如果不存在"内容场景"，选择第一个可用的标签系列
- **切换响应**：切换标签系列后，自动重新计算统计数据
- **偏好保存**：选择后保存到localStorage，存储键为 `tag_analysis_selected_tag_set_${reportId}`，下次进入时自动恢复
- **标签配置**：暂不需要配置功能，标签由标签管理模块统一管理。如果后续需要标签排序、筛选等功能，再考虑添加
- **未选择状态**：未选择标签系列时，显示提示"请先选择标签系列"，不展示统计表格

### 2.2 统计维度

基于所选标签系列，按标签维度进行统计，统计指标包括：

#### 2.2.1 基础统计指标

- **标签名称**：当前标签系列下的标签名称
- **笔记数量**：该标签关联的笔记数量（及占比）
- **达人数量**：该标签关联的笔记涉及的达人数量（及占比）
- **平均粉丝数**：该标签下所有达人的平均粉丝数（简单平均，每个达人只计算一次）

#### 2.2.2 互动数据指标

- **总互动量**：点赞 + 收藏 + 评论（及占比）
- **点赞**：总点赞数（及占比）
- **收藏**：总收藏数（及占比）
- **评论**：总评论数（及占比）
- **分享**：总分享数（及占比）

#### 2.2.3 商业数据指标

- **合作金额**：该标签下所有笔记的合作金额总和（及占比）
- **笔记单价**：合作金额 / 笔记数量（元/笔记）

### 2.3 数据展示

- **表格展示**：使用 Ant Design Table 组件展示统计数据
- **排序功能**：支持按各指标列排序（默认按笔记数量降序）
- **占比显示**：各指标下方显示占比百分比（灰色小字，格式：`XX.X%`）
- **标签行**：包含各标签的统计数据，如果存在未打标笔记，包含"未打标"行
- **总计行**：表格底部显示总计行，汇总所有标签的数据
  - 总计行的占比固定为100%（作为基准）
  - 注意：由于笔记可能重复计算，各标签占比之和可能超过100%

### 2.4 导出功能

- **导出Excel**：支持导出统计数据为Excel文件
- **文件命名**：`{报告名}_内容标签_汇总明细_{时间戳}.xlsx`
  - 时间戳格式：`YYYYMMDD-HHmmss`（Asia/Shanghai时区）
- **Sheet结构**：
  - **汇总Sheet**：包含各标签的统计数据（与表格展示一致）
    - 列顺序：标签名称、笔记数量、笔记占比%、达人数量、达人占比%、平均粉丝数、合作金额、合作金额占比%、笔记单价、总互动量、总互动量占比%、点赞、点赞占比%、收藏、收藏占比%、评论、评论占比%、分享、分享占比%
    - 包含"未打标"行（如果有未打标笔记），位置：放在所有标签行之后，总计行之前
    - 最后一行是总计行（tagName="总计"）
  - **明细Sheet**：包含所有笔记的详细信息，首列为标签名称
    - 一条笔记一条记录（与达人矩阵明细一致）
    - **tagName格式**：如果笔记有多个标签，tagName用逗号分隔，格式为"标签1,标签2,标签3"（无空格）
    - **tagName排序规则**：多个标签按关联时间降序排序（后关联的在前）
    - "未打标"笔记的tagName="未打标"
    - **排序规则**：先按发布时间降序（最新的在前），如果发布时间相同，则按数据库返回顺序
    - 字段顺序与达人矩阵明细完全一致，首列增加"标签名称"

## 3. 数据计算规则

### 3.1 标签统计范围

- **数据源**：基于当前报告中的所有有效笔记（`qiangua_report_note_rel.Status = 'active'`）
- **标签范围**：仅统计所选标签系列下的标签
- **笔记筛选**：仅统计已关联所选标签系列下至少一个标签的笔记

### 3.2 笔记统计规则

**规则说明**：
- **多标签笔记处理**：如果一篇笔记同时关联了多个标签（在同一标签系列下），该笔记会在多个标签中**重复计算**
- **标签行统计逻辑**：笔记数量、互动量、合作金额等指标在各标签中分别累加（不去重）
  - 标签行的笔记数量 = 该标签关联的所有笔记数量（不去重）
  - 标签行的互动量 = 该标签关联的所有笔记的互动量总和（不去重）
  - 标签行的合作金额 = 该标签关联的所有笔记的合作金额总和（不去重）
- **总计行统计逻辑**：所有指标都基于去重后的笔记总数计算
  - 总计行的笔记数量 = 报告内所有有效笔记总数（去重后）
  - 总计行的互动量 = 所有笔记的互动量总和（去重后，每篇笔记的互动量只计算一次）
  - 总计行的合作金额 = 所有笔记的合作金额总和（去重后，每篇笔记的合作金额只计算一次）
- **业务合理性**：一篇笔记可能同时属于多个内容场景（如"品牌品宣"和"明星代言"），标签行重复计算更符合标签分析的业务场景，总计行去重更符合整体统计需求
- **实现方式**：
  - 在应用层处理：基于拉取的原始数据，按标签维度进行统计
  - 标签行：允许重复计算（多标签笔记在各标签中分别统计，不去重）
  - 总计行：基于去重后的笔记总数计算（每篇笔记的指标只计算一次）

**示例**：
- 笔记A同时关联了"品牌品宣"和"明星代言"两个标签
- 笔记A的点赞数为1000，合作金额为5000元
- 统计结果：
  - "品牌品宣"标签行：笔记数量+1（笔记A），点赞数+1000，合作金额+5000
  - "明星代言"标签行：笔记数量+1（笔记A），点赞数+1000，合作金额+5000
  - **总计行**：笔记数量=1（笔记A只计算一次），点赞数=1000（笔记A的点赞数只计算一次），合作金额=5000（笔记A的合作金额只计算一次）

**注意**：
- 标签行中的笔记数量、互动量、合作金额允许重复计算（符合标签分析业务需求）
- 总计行中的笔记数量、互动量、合作金额都基于去重后的笔记总数计算（符合整体统计需求）

### 3.3 达人去重规则

- **达人统计**：统计该标签下所有笔记涉及的达人数量（**去重**）
  - 如果同一达人的多篇笔记都关联了该标签，达人数量只计算1次
- **平均粉丝数**：按达人简单平均计算
  - 公式：`AVG(达人粉丝数)`（每个达人只计算一次）
  - 计算方式：统计该标签下所有唯一达人的粉丝数，取平均值
  - **实现方式**：在应用层处理，一次读取所有笔记数据，然后按达人去重
  - **重复达人处理**：如果同一达人在多条笔记中出现，选择粉丝数最高的那个值（防止偶发低值覆盖）

### 3.4 占比计算规则

- **笔记占比**：该标签的笔记数量（不去重） / 报告内所有有效笔记总数（去重后）
- **互动占比**：该标签的互动量（不去重） / 报告内所有笔记的互动量总和（去重后）
- **金额占比**：该标签的合作金额（不去重） / 报告内所有笔记的合作金额总和（去重后）
- **达人占比**：该标签的达人数量（去重后） / 报告内所有唯一达人总数（去重后）

**重要说明**：
- **分母计算**：所有占比的分母都基于去重后的笔记总数/互动量总和/合作金额总和/达人总数
- **分子计算**：标签行的占比分子基于该标签的指标值（笔记数量、互动量、合作金额不去重；达人数量去重）
- **占比特点**：由于笔记可能在多个标签中重复计算，**各标签占比之和可能超过100%**（笔记占比、互动占比、金额占比）
- **总计行占比**：总计行的所有占比固定为100%（作为基准）
- **达人占比**：达人占比基于去重后的唯一达人总数，因此达人占比之和为100%

### 3.5 未打标笔记处理

**规则说明**：
- **增加"未打标"行**：统计在所选标签系列下未关联任何标签的笔记
- **统计指标**：与普通标签行一致，包括笔记数量、达人数量、互动量、合作金额等
- **业务价值**：便于了解打标覆盖率，识别未打标的笔记数量

**计算逻辑**：
- 在应用层判断：笔记不在标签关联关系查询结果中，即为未打标
- 查询报告内所有有效笔记
- 排除已关联所选标签系列下任意标签的笔记（通过标签关联关系查询结果判断）
- 对剩余笔记进行统计聚合

### 3.6 总计行计算规则

- **笔记数量总计**：报告内所有有效笔记总数（去重后，包含已打标和未打标笔记）
- **达人数量总计**：报告内所有唯一达人总数（去重后，包含已打标和未打标笔记涉及的达人）
- **互动量总计**：报告内所有笔记的互动量总和（去重后，每篇笔记的互动量只计算一次）
- **合作金额总计**：报告内所有笔记的合作金额总和（去重后，每篇笔记的合作金额只计算一次）
- **平均粉丝数总计**：所有唯一达人的简单平均粉丝数（公式：`Σ(达人粉丝数) / 唯一达人总数`，去重后计算）
- **笔记单价总计**：合作金额总计 / 笔记数量总计
- **占比**：总计行的所有占比固定为100%（作为基准）

## 4. 技术实现

### 4.0 数据拉取策略

**总体策略**：使用简单的 SELECT 查询拉取原始数据，在应用层进行所有数据聚合和计算。

**数据拉取步骤**：
1. **拉取报告内所有有效笔记**：一次性加载所有笔记数据到内存
2. **拉取标签关联关系**：使用 JOIN 方式查询，避免 URL 长度限制问题
   - 通过 JOIN `qiangua_report_note_rel` 直接过滤报告范围
   - 通过 JOIN `qiangua_tag` 过滤标签系列
   - 不需要过滤 `UserId`，标签关联关系与当前用户无关
3. **拉取标签信息**（可选）：如果标签关联关系查询已包含标签名称，可省略

**应用层处理**：
- 基于拉取的原始数据，在应用层进行所有数据聚合、统计和计算
- 处理多标签笔记的重复计算逻辑
- 计算占比（分母基于去重后的总数，分子基于标签行的不去重数值）
- 生成汇总和明细数据
- 计算平均粉丝数（按达人去重后计算）

### 4.1 API接口设计

#### 4.1.1 统计数据接口

**接口路径**：`GET /api/reports/[id]/tag-analysis/stats`

**请求参数**：
- `tagSetId`（必填）：标签系列ID

**响应数据结构**：
```typescript
interface TagStats {
  tagId: string | null; // null表示"未打标"行，"总计"行的tagId也为null
  tagName: string; // "未打标"行的tagName为"未打标"，"总计"行的tagName为"总计"
  notesCount: number;
  notesPercentage: number;
  bloggerCount: number;
  bloggerPercentage: number;
  avgFans: number;
  totalInteraction: number;
  totalInteractionPercentage: number;
  totalLiked: number;
  totalLikedPercentage: number;
  totalCollected: number;
  totalCollectedPercentage: number;
  totalComments: number;
  totalCommentsPercentage: number;
  totalShares: number;
  totalSharesPercentage: number;
  totalAdPrice: number;
  totalAdPricePercentage: number;
  adPricePerNote: number;
}

interface TagAnalysisResponse {
  success: boolean;
  data: {
    rows: TagStats[]; // 包含各标签行和"未打标"行，最后一行是总计行
    details: Array<{
      tagName: string; // 如果笔记有多个标签，用逗号分隔（按关联时间降序排序）；"未打标"笔记的tagName为"未打标"
      noteId: string;
      title: string | null;
      content: string | null;
      coverImage: string | null;
      noteType: string | null;
      isBusiness: boolean | null;
      isAdNote: boolean | null;
      publishTime: string | null;
      likedCount: number | null;
      collectedCount: number | null;
      commentsCount: number | null;
      viewCount: number | null;
      shareCount: number | null;
      fans: number | null;
      adPrice: number | null;
      bloggerId: string;
      bloggerNickName: string | null;
      bloggerSmallAvatar: string | null;
      bloggerBigAvatar: string | null;
      officialVerified: boolean | null;
      brandId: string | null;
      brandIdKey: string | null;
      brandName: string | null;
      videoDuration: string | null;
      status: string | null;
      addedAt: string | null;
    }>;
  };
}
```

**明细数据生成规则**：
- **记录数量**：一条笔记一条记录（与达人矩阵明细一致）
- **多标签笔记处理**：如果一篇笔记有多个标签，tagName用逗号分隔，格式为"标签1,标签2,标签3"（无空格）
- **tagName排序规则**：多个标签按关联时间降序排序（后关联的在前）
  - 例如：笔记A关联了"品牌品宣"（关联时间：2024-01-01）和"明星代言"（关联时间：2024-01-02）
  - 明细中：`tagName="明星代言,品牌品宣"`（后关联的在前）
- **未打标笔记处理**："未打标"笔记也生成明细记录，tagName="未打标"
- **业务价值**：便于在Excel中查看每条笔记的所有标签，一条记录包含笔记的完整信息
- **排序规则**：先按发布时间降序（最新的在前），如果发布时间相同，则按数据库返回顺序
- **示例**：笔记A关联了"品牌品宣"和"明星代言"，明细数据中生成1条记录：
  - 记录：tagName="明星代言,品牌品宣"（假设"明星代言"后关联）, noteId="A", ...

**错误处理**：
- `tagSetId` 不存在：返回 404 错误
- 用户无权访问标签系列：返回 403 错误
- 报告不存在：返回 404 错误
- 用户无权访问报告：返回 403 错误
- 参数缺失（如缺少 `tagSetId`）：返回 400 错误
- 服务器错误：返回 500 错误
- 标签系列下没有标签：返回空数组（rows为空，details为空）

### 4.2 前端组件设计

#### 4.2.1 组件结构

- **组件路径**：`components/reports/TagAnalysis.tsx`
- **组件名称**：`TagAnalysis`
- **Props**：
  ```typescript
  interface TagAnalysisProps {
    reportId: string;
    refreshKey?: number; // 用于触发重新加载
  }
  ```

#### 4.2.2 UI布局

```
+--------------------------------------------------------------------------------+
| 内容标签分析 [下拉选择标签系列]                          [前往打标] [导出Excel]  |
+--------------------------------------------------------------------------------+
| 统计表格：                                                                     |
| +--------+--------+--------+--------+--------+--------+--------+--------+   |
| | 标签   | 笔记数 | 达人数 | 平均粉 | 合作金 | 笔记单 | 总互动 | 点赞   |   |
| | 名称   | 量(占) | 量(占) | 丝数   | 额(占) | 价     | 量(占) | (占)   |   |
| +--------+--------+--------+--------+--------+--------+--------+--------+   |
| | 品牌品 | 100    | 50     | 10万   | 5万    | 500    | 1万    | 8000   |   |
| | 宣     | (20%)  | (25%)  |        | (15%)  |        | (18%)  | (16%)  |   |
| +--------+--------+--------+--------+--------+--------+--------+--------+   |
| | ...    | ...    | ...    | ...    | ...    | ...    | ...    | ...    |   |
| +--------+--------+--------+--------+--------+--------+--------+--------+   |
| | 总计   | 500    | 200    | 8万    | 30万   | 600    | 5万    | 4万    |   |
| |        | (100%) | (100%) |        | (100%) |        | (100%) | (100%) |   |
| +--------+--------+--------+--------+--------+--------+--------+--------+   |
+--------------------------------------------------------------------------------+
```

#### 4.2.3 交互逻辑

1. **标签系列选择**：
   - 使用 `Select` 组件，加载当前用户可见的标签系列（系统 + 自定义）
   - 从 `localStorage` 读取上次选择：`tag_analysis_selected_tag_set_${reportId}`
   - 选择后保存到 `localStorage`，并触发统计数据重新加载
   - 未选择时显示空状态提示，不展示统计表格

2. **数据加载**：
   - 使用 `useState` 和 `useEffect` 管理加载状态
   - 依赖项：`reportId`, `selectedTagSetId`, `refreshKey`
   - 加载中显示 `Spin` 组件
   - 加载失败显示错误提示（使用 `message.error`）
   - **缓存策略**：不需要缓存，每次切换标签系列或refreshKey变化时都重新请求，确保数据实时性
   - **空状态处理**：空数据时显示 `Empty` 组件，提供操作引导
     - 场景1：未选择标签系列 - 提示"请先选择标签系列"
     - 场景2：标签系列下没有标签 - 提示"该标签系列下暂无标签，请前往标签管理页面创建标签"，跳转链接：`/dashboard/tags`
     - 场景3：没有已打标的笔记 - 提示"该标签系列下暂无已打标的笔记，请前往笔记打标页面进行打标"，跳转链接：`/dashboard/notes/tagging`

3. **前往打标功能**：
   - 点击"前往打标"按钮，跳转到笔记打标页面（`/dashboard/notes/tagging`）
   - 通过URL参数传入：
     - `tagSetId`：当前选中的标签系列ID
     - `reportId`：当前报告ID
   - 跳转链接格式：`/dashboard/notes/tagging?tagSetId=${selectedTagSetId}&reportId=${reportId}`
   - **功能作用**：限定标签系列和需要打标的笔记范围，便于用户快速进入打标页面进行打标操作
   - **前置条件**：必须已选择标签系列，未选择时按钮置灰或禁用

4. **导出功能**：
   - 点击"导出Excel"按钮，调用导出逻辑
   - 使用 `xlsx` 库生成Excel文件（动态导入，避免类型依赖问题）
   - 包含汇总和明细两个sheet
   - 文件命名：`{报告名}_内容标签_汇总明细_{时间戳}.xlsx`
   - 时间戳使用 Asia/Shanghai 时区

5. **表格交互**：
   - 支持列排序（点击列头）
   - 默认按笔记数量降序
   - 占比显示在数值下方（灰色小字）
   - 总计行固定在底部，不可排序

## 5. 实现计划

### 5.1 后端实现

1. **API接口开发**
   - 创建 `app/api/reports/[id]/tag-analysis/stats/route.ts`
   - 实现标签维度的数据聚合逻辑
   - **数据拉取逻辑**：
     - **步骤1**：查询报告内所有有效笔记（获取完整笔记数据）
       ```sql
       SELECT * FROM qiangua_note_info n
       JOIN qiangua_report_note_rel rnr ON n."NoteId" = rnr."NoteId"
       WHERE rnr."ReportId" = :reportId 
         AND rnr."Status" = 'active'
       ```
     - **步骤2**：查询标签关联关系（使用 JOIN 方式，避免 URL 长度问题）
       ```sql
       SELECT nt."NoteId", nt."TagId", nt."CreatedAt", t."TagName", t."TagSetId"
       FROM qiangua_note_tag nt
       JOIN qiangua_tag t ON nt."TagId" = t."TagId"
       JOIN qiangua_report_note_rel rnr ON nt."NoteId" = rnr."NoteId"
       WHERE t."TagSetId" = :tagSetId
         AND rnr."ReportId" = :reportId
         AND rnr."Status" = 'active'
       ```
       - **说明**：使用 JOIN 方式直接过滤，而不是先获取 NoteId 列表再用 IN 子句，避免 URL 长度限制问题
       - **返回字段**：`NoteId`、`TagId`、`CreatedAt`（关联时间）、`TagName`、`TagSetId`
       - **注意**：不需要过滤 `UserId`，标签关联关系与当前用户无关
     - **步骤3**：查询标签信息（可选，如果步骤2已包含标签名称）
       ```sql
       SELECT * FROM qiangua_tag
       WHERE "TagSetId" = :tagSetId
       ```
   - **应用层处理逻辑**：
     - 在应用层处理所有数据聚合和计算
     - 基于拉取的原始数据，按标签维度进行统计
     - 处理多标签笔记的重复计算逻辑
     - 计算占比（分母基于去重后的总数，分子基于标签行的不去重数值）
     - 生成汇总和明细数据
   - **核心计算逻辑**：
     ```sql
     -- 1. 查询各标签的统计数据（包含多标签笔记的重复计算）
     -- 注意：使用 COUNT(nt."NoteId") 而非 COUNT(DISTINCT nt."NoteId") 以支持重复计算
     -- 实际实现：在应用层基于拉取的原始数据计算
     -- 逻辑说明：
     --   - 标签行的笔记数量 = 该标签关联的所有笔记数量（不去重）
     --   - 标签行的互动量 = 该标签关联的所有笔记的互动量总和（不去重）
     --   - 标签行的合作金额 = 该标签关联的所有笔记的合作金额总和（不去重）
     
     -- 2. 查询未打标笔记的统计数据
     -- 实际实现：在应用层判断，笔记不在标签关联关系查询结果中，即为未打标
     -- 逻辑说明：
     --   - 查询报告内所有有效笔记
     --   - 排除已关联所选标签系列下任意标签的笔记
     --   - 对剩余笔记进行统计聚合
     
     -- 3. 计算总计行（基于去重后的笔记总数）
     -- 注意：总计行的所有指标都基于去重后的笔记总数计算
     -- 实际实现：在应用层基于所有有效笔记（去重后）计算
     -- 逻辑说明：
     --   - 总计行的笔记数量 = 报告内所有有效笔记总数（去重后）
     --   - 总计行的互动量 = 所有笔记的互动量总和（去重后，每篇笔记的互动量只计算一次）
     --   - 总计行的合作金额 = 所有笔记的合作金额总和（去重后，每篇笔记的合作金额只计算一次）
     
     -- 4. 生成明细数据（一条笔记一条记录，多个标签用逗号分隔）
     -- 实际实现：在应用层处理
     -- 步骤：
     --   a. 基于步骤2的标签关联关系数据，按 NoteId 分组
     --   b. 将同一笔记的多个标签按关联时间（CreatedAt）降序排序后合并为逗号分隔的字符串
     --   c. 合并步骤1的笔记数据，添加合并后的 tagName
     --   d. 对于未打标笔记，tagName 设为"未打标"
     --   e. 按发布时间降序排序
     ```
   - **平均粉丝数计算**：
     - 在应用层处理，一次读取所有笔记数据
     - 按达人去重，对于重复达人记录，选择粉丝数最高的那个值
     - 然后计算平均值：`AVG(唯一达人的粉丝数)`
     - 参考达人矩阵分析的实现方式（见 `app/api/reports/[id]/blogger-matrix/stats/route.ts`）

2. **数据库查询优化**
   - **数据拉取策略**：使用简单的 SELECT 查询拉取原始数据，不做聚合
     - 一次性加载所有笔记数据到内存
     - 使用 JOIN 方式查询标签关联关系，避免 URL 长度限制问题
     - 在应用层进行所有数据聚合和计算
   - **性能目标**：1万条笔记的统计查询应在3秒内完成
   - 建立必要的索引：
     - `qiangua_note_tag.TagId`（已存在）
     - `qiangua_note_tag.NoteId`（已存在）
     - `qiangua_report_note_rel.ReportId, Status`（复合索引，已存在）
     - `qiangua_tag.TagSetId`（已存在）
   - 使用 `EXPLAIN ANALYZE` 分析查询性能
   - **平均粉丝数计算**：在应用层处理，一次读取所有笔记数据，按达人去重后计算平均值
     - 对于重复达人记录，选择粉丝数最高的那个值（防止偶发低值覆盖）

### 5.2 前端实现

1. **组件开发**
   - 创建 `components/reports/TagAnalysis.tsx`
   - **核心功能**：
     - 标签系列选择器（从 `/api/tag-sets` 加载，支持系统+自定义）
     - localStorage 偏好保存和恢复
     - 统计表格展示（使用 Ant Design Table）
     - Excel导出功能（参考 `BloggerMatrixAnalysis.tsx` 的实现）
   - **状态管理**：
     - `selectedTagSetId`: 当前选中的标签系列ID
     - `stats`: 统计数据数组
     - `loading`: 加载状态
   - **Props接口**：
     ```typescript
     interface TagAnalysisProps {
       reportId: string;
       refreshKey?: number; // 用于触发重新加载（当笔记打标/清除时）
     }
     ```

2. **集成到报告页面**
   - 在 `app/dashboard/reports/page.tsx` 中集成 `TagAnalysis` 组件
   - 与"达人矩阵属性分析"模块并列展示
   - 使用相同的 `refreshKey` 机制，当有效笔记集合变化时触发刷新
   - 位置：在"达人矩阵属性分析"模块下方（垂直排列）

3. **API调用**
   - 标签系列列表：`GET /api/tag-sets?withTags=false`
   - 统计数据：`GET /api/reports/[id]/tag-analysis/stats?tagSetId=xxx`

### 5.3 测试验证

1. **功能测试**
   - **多标签笔记统计**：
     - 创建一篇笔记，关联多个标签（同一标签系列）
     - 验证该笔记在各标签中都被统计（标签行重复计算）
     - 验证笔记数量、互动量等指标在各标签中分别累加（不去重）
     - 验证总计行的笔记数量、互动量等指标基于去重后的笔记总数计算
   - **未打标笔记统计**：
     - 创建未打标的笔记
     - 验证"未打标"行正确显示统计数据
   - **占比计算**：
     - 验证各标签占比计算正确（分母基于去重后的总数，分子基于标签行的不去重数值）
     - 验证由于重复计算，占比之和可能超过100%（笔记占比、互动占比、金额占比）
     - 验证总计行占比固定为100%
     - 验证达人占比之和为100%（因为达人数量去重）
   - **标签系列切换**：
     - 验证切换标签系列后数据正确刷新
     - 验证localStorage偏好保存和恢复
   - **导出功能**：
     - 验证汇总sheet包含所有标签行和总计行
     - 验证明细sheet中一条笔记一条记录，多标签笔记的tagName用逗号分隔
     - 验证tagName中多个标签按关联时间降序排序（后关联的在前）
     - 验证明细数据按发布时间降序排序
     - 验证文件命名和时间戳格式正确

2. **性能测试**
   - **查询性能**：
     - 测试1万条笔记的统计查询（目标：3秒内完成）
     - 测试10万条笔记的统计查询（目标：10秒内完成）
     - 使用 `EXPLAIN ANALYZE` 分析SQL执行计划
   - **导出性能**：
     - 测试1万条笔记的导出（目标：5秒内完成）
     - 测试内存使用情况（避免内存溢出）

3. **边界测试**
   - 标签系列下没有标签
   - 标签系列下没有已打标的笔记
   - 报告内没有笔记
   - 所有笔记都未打标
   - 所有笔记都打标（无未打标行）
   
**注意**：测试数据准备无需特殊处理，使用现有报告和笔记数据即可

## 6. 参考文档

- 达人矩阵分析组件：`components/reports/BloggerMatrixAnalysis.tsx`
- 达人矩阵统计API：`app/api/reports/[id]/blogger-matrix/stats/route.ts`
- 标签化功能规格：`笔记内容标签化.md`
- 标签化业务逻辑：`笔记标签化业务逻辑.md`

